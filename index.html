<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paradise</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
</head>
<body>

  <!-- –ï–∫—Ä–∞–Ω –≤—Ö–æ–¥—É -->
  <div class="login-screen" id="loginScreen">
    <h2>–í—Ö—ñ–¥ —É –ø–∞—Ä–∞–¥–∞–π–∑</h2>
    <input type="password" id="passwordInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å" />
    <div id="nicknameSelection" style="display: none;">
      <p>–í–∏–±–µ—Ä–∏ —Å–≤—ñ–π –Ω—ñ–∫–Ω–µ–π–º –º–∞–Ω—é–Ω—è –º–æ—è:</p>
      <button onclick="chooseNickname('Baby üòé')">Baby üòé</button>
      <button onclick="chooseNickname('Pink Cloud ‚òÅÔ∏è')">Pink Cloud ‚òÅÔ∏è</button>
    </div>
    <button id="loginButton" onclick="checkPassword()">–£–≤—ñ–π—Ç–∏</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- –ß–∞—Ç -->
  <div class="chat-container" id="chatContainer" style="display: none;">
    <h1>üå∏ ‚ù§ Rakhiv Paradise ‚ù§ üå∏</h1>
    <button id="openGalleryBtn" class="gallery-toggle-btn">üñºÔ∏è</button>
    <div id="chat" class="chat-box"></div>
    <!-- –ù–æ–≤–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –Ω–∞–±–æ—Ä—É —Ç–µ–∫—Å—Ç—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —á–∞—Ç—É -->
    <div id="chatTypingIndicator" class="typing-message-in-chat" style="visibility: hidden;"></div>
     <div class="media-controls-area">
      <!-- ... –∫–Ω–æ–ø–∫–∏ –º—É–∑–∏–∫–∏ —Ç–∞ –≥—É—á–Ω–æ—Å—Ç—ñ ... -->
    </div>
    <!-- –ë–ª–æ–∫ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ - –ü–ï–†–ï–ú–Ü–©–ï–ù–û –°–Æ–î–ò -->
    <div id="replyPreview" class="reply-preview" style="display: none;">
      <div class="reply-preview-content"><strong id="replyPreviewUser"></strong>: <span id="replyPreviewText"></span></div>
      <button id="cancelReplyBtn" class="cancel-reply-btn">&times;</button>
    </div>
    <div class="input-controls">
      <textarea class="chat-input" id="msgInput" placeholder="–ù–∞–ø–∏—à–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." rows="1"></textarea>
      <button id="emojiToggleBtn" class="emoji-toggle-btn">üòä</button>
      <input type="file" id="imageInput" accept="image/*" style="display: none;">
      <button id="attachImageBtn" class="attach-btn">üìé</button>
      <button class="chat-button">üí¨</button>
      <div id="emojiPanel" class="emoji-panel" style="display: none;">
        <!-- –ï–º–æ–¥–∑—ñ –±—É–¥—É—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ —Å—é–¥–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é JavaScript -->
      </div>
    </div>
    <div class="status-messages-container">
      <div id="users-online" class="users-online"></div>      
      <div id="imageUploadIndicator" class="upload-indicator" style="display: none;">–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è... üñºÔ∏è</div>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω—å –∑ —á–∞—Ç—É -->
  <div id="chatImageDisplayModal" class="gallery-modal" style="display: none;">
    <button id="closeChatImageDisplayModalBtn" class="gallery-close-btn">&times;</button>
    <div class="gallery-content">
      <img id="chatDisplayImage" src="" alt="–ó–±—ñ–ª—å—à–µ–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ —á–∞—Ç—É" style="max-width: 90vw; max-height: 90vh; object-fit: contain;" />
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≥–∞–ª–µ—Ä–µ—ó -->
  <div id="imageGalleryModal" class="gallery-modal" style="display: none;">
    <button id="closeGalleryBtn" class="gallery-close-btn">&times;</button>
    <div class="gallery-content">
      <button id="prevImageBtn" class="gallery-nav-btn prev-btn" aria-label="Previous image">&lt;</button>
      <div class="gallery-images-container" id="galleryImagesContainer">
        <!-- –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±—É–¥—É—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ —Å—é–¥–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é JavaScript -->
      </div>
      <button id="nextImageBtn" class="gallery-nav-btn next-btn" aria-label="Next image">&gt;</button>
    </div>
  </div>
  <script>
    let selectedNickname = null;
    let socket = null;
    // –û–≥–æ–ª–æ—à—É—î–º–æ –ø–ª–µ—î—Ä —Ç–∞ –ø–æ–≤'—è–∑–∞–Ω—ñ –∑–º—ñ–Ω–Ω—ñ —Ç—É—Ç, —â–æ–± –≤–æ–Ω–∏ –±—É–ª–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ñ –≤ –º–µ–∂–∞—Ö —Å–∫—Ä–∏–ø—Ç–∞
    const musicPlayer = new Audio();
    let currentPlayingButton = null;
    let currentReplyInfo = null; // –î–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –Ω–∞ —è–∫–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î–º–æ
    let currentSongSrc = null;

    const avatars = {
     "Baby üòé": "üòé",
     "Pink Cloud ‚òÅÔ∏è": "‚òÅÔ∏è"
    };
    
    const userColors = {
     "Baby üòé": "message-baby",
     "Pink Cloud ‚òÅÔ∏è": "message-cloud"
    };

    function checkPassword() {
      const password = document.getElementById('passwordInput').value;
      const loginButton = document.getElementById('loginButton');
      if (password === "26060512") {
        document.getElementById('nicknameSelection').style.display = "block";
  passwordInput.style.display = "none"; // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –ø–æ–ª–µ –ø–∞—Ä–æ–ª—è
  loginButton.style.display = "none";   // –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∫–Ω–æ–ø–∫—É "–£–≤—ñ–π—Ç–∏"
  document.getElementById('loginError').textContent = "";
      } else {
        document.getElementById('loginError').textContent = "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–∞—Ä–æ–ª—å.";
      }
    }

    function chooseNickname(nick) {
      selectedNickname = nick;
      document.getElementById('loginScreen').style.display = "none";
      document.getElementById('chatContainer').style.display = "flex";
      startChat();
    }

    function startChat() {
      socket = io("https://cloud-baby.onrender.com", {
        transports: ["websocket"]
      });

      const chat = document.getElementById('chat'); // Explicitly define chat
      socket.emit("register", selectedNickname); // –ø–µ—Ä–µ–¥–∞—î–º–æ –Ω—ñ–∫


      socket.on("message", (data) => { // –û–±—Ä–æ–±–Ω–∏–∫ –Ω–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        const messageElement = renderMessage(data); // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ renderMessage –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –µ–ª–µ–º–µ–Ω—Ç–∞
        chat.appendChild(messageElement);
        scrollToBottom();
      });

      socket.on('message_edited', (data) => {
        const messageDiv = document.querySelector(`.message[data-message-id="${data.messageId}"]`);
        if (messageDiv) {
          const textContentElement = messageDiv.querySelector('.message-text-content');
          if (textContentElement) {
            textContentElement.textContent = data.newText; // –û–Ω–æ–≤–ª—é—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ç–µ–∫—Å—Ç

            // –î–æ–¥–∞—î–º–æ –∞–±–æ –æ–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–Ω–∞—á–∫—É "(–≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ)"
            let editedMark = messageDiv.querySelector('.edited-indicator');
            if (!editedMark) {
              editedMark = document.createElement('span');
              editedMark.classList.add('edited-indicator');
              editedMark.style.fontSize = '0.8em'; // –¢—Ä–æ—Ö–∏ –º–µ–Ω—à–∏–π —à—Ä–∏—Ñ—Ç –¥–ª—è –ø–æ–∑–Ω–∞—á–∫–∏
              editedMark.style.marginLeft = '5px'; // –ù–µ–≤–µ–ª–∏–∫–∏–π –≤—ñ–¥—Å—Ç—É–ø
              editedMark.textContent = '(–≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ)';
              textContentElement.insertAdjacentElement('afterend', editedMark);
            }
          }
        }
      });

      socket.on('message_deleted', (data) => {
        const messageDiv = document.querySelector(`.message[data-message-id="${data.messageId}"]`);
        if (messageDiv) {
          messageDiv.remove();
        }
      });

      socket.on("chat_history", (messages) => { // –û–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –æ–±—Ä–æ–±–∫–∏ –∑–æ–±—Ä–∞–∂–µ–Ω—å –≤ —ñ—Å—Ç–æ—Ä—ñ—ó
        messages.forEach(data => {
          const messageElement = renderMessage(data); // renderMessage —Ç–µ–ø–µ—Ä –ø–æ–≤–µ—Ä—Ç–∞—î –µ–ª–µ–º–µ–Ω—Ç
          chat.appendChild(messageElement);
        });
        scrollToBottom();
      });

      socket.on("users_online", (users) => {
        const usersOnlineDiv = document.getElementById('users-online');
        let displayString = "";

        const hasBaby = users.includes("Baby üòé");
        const hasCloud = users.includes("Pink Cloud ‚òÅÔ∏è");

        if (hasBaby && hasCloud) {
          displayString = `
            <div class="finger-lightning-container">
              <div class="finger left">üëâ</div>
              <div class="lightning"></div>
              <div class="finger right">üëà</div>
            </div>
          `;
        } else if (hasBaby) {
          displayString = `<div class="finger-lightning-container"><div>üëâ</div></div>`;
        } else if (hasCloud) {
          displayString = `<div class="finger-lightning-container"><div>üëà</div></div>`;
        }
        
        usersOnlineDiv.innerHTML = displayString || "–ù—ñ–∫–æ–≥–æ –Ω–µ–º–∞—î –≤ –º–µ—Ä–µ–∂—ñ";
      });

      socket.on("typing", (data) => {
        const chatTypingIndicator = document.getElementById("chatTypingIndicator"); // –ù–æ–≤–∏–π —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä
        if (data.typing) {          
          const userAvatar = avatars[data.user] || "üë§"; // –í–∏–∑–Ω–∞—á–∞—î–º–æ userAvatar —Ç—É—Ç
          chatTypingIndicator.textContent = `${userAvatar} ${data.user} —à–æ—Å—å —Ç–∞–º —Ü—ñ–∫–∞–≤–µ–Ω—å–∫–µ –ø–∏—à–µ...–ª—é–±–ª—è—á–∏ —Ç–µ–±–µ –¥—É–∂–µ —Å–∏–ª—å–Ω–æ!`;
          chatTypingIndicator.style.visibility = 'visible';
          scrollToBottom(); // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç–∏ –≤–Ω–∏–∑, —â–æ–± –±—É–ª–æ –≤–∏–¥–Ω–æ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä
        } else {
          chatTypingIndicator.style.visibility = 'hidden';
          // chatTypingIndicator.textContent = '\u00A0'; // –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –Ω–µ—Ä–æ–∑—Ä–∏–≤–Ω–∏–π –ø—Ä–æ–±—ñ–ª, —â–æ–± –≥–∞—Ä–∞–Ω—Ç—É–≤–∞—Ç–∏ –≤–∏—Å–æ—Ç—É, —è–∫—â–æ min-height –Ω–µ —Å–ø—Ä–∞—Ü—é—î
        }
      });


      socket.emit("get_history");

      const msgInput = document.getElementById("msgInput");
      let typingTimeout;

      msgInput.addEventListener("input", () => {
        socket.emit("typing", true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.emit("typing", false);
        }, 2000);
      });

      msgInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      document.querySelector(".chat-button").addEventListener("click", () => sendMessage());
      
      const attachImageBtn = document.getElementById('attachImageBtn');
      const imageInput = document.getElementById('imageInput');

      attachImageBtn.addEventListener('click', () => {
        imageInput.click(); // –í—ñ–¥–∫—Ä–∏—Ç–∏ –¥—ñ–∞–ª–æ–≥ –≤–∏–±–æ—Ä—É —Ñ–∞–π–ª—É
      });

      imageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
          const uploadIndicator = document.getElementById('imageUploadIndicator');
          uploadIndicator.style.display = 'block'; // –ü–æ–∫–∞–∑–∞—Ç–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä

          const reader = new FileReader();
          reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
              const canvas = document.createElement('canvas');
              const MAX_WIDTH = 800; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ —à–∏—Ä–∏–Ω–∞
              const MAX_HEIGHT = 600; // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –≤–∏—Å–æ—Ç–∞
              let width = img.width;
              let height = img.height;

              if (width > height) {
                if (width > MAX_WIDTH) {
                  height *= MAX_WIDTH / width;
                  width = MAX_WIDTH;
                }
              } else {
                if (height > MAX_HEIGHT) {
                  width *= MAX_HEIGHT / height;
                  height = MAX_HEIGHT;
                }
              }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              // –û—Ç—Ä–∏–º—É—î–º–æ —Å—Ç–∏—Å–Ω–µ–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è —è–∫ JPEG –∑ —è–∫—ñ—Å—Ç—é 0.9 (–º–æ–∂–Ω–∞ –∑–º—ñ–Ω—é–≤–∞—Ç–∏)
              const compressedImageDataUrl = canvas.toDataURL('image/jpeg', 0.9); 

              socket.emit("message", { type: 'image', image: compressedImageDataUrl }, () => {
                uploadIndicator.style.display = 'none';
              });
            }
            img.src = e.target.result; // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–ª—è –æ–±—Ä–æ–±–∫–∏
          }
          reader.readAsDataURL(file);
          imageInput.value = ''; // –°–∫–∏–¥–∞—î–º–æ –∑–Ω–∞—á–µ–Ω–Ω—è —ñ–Ω–ø—É—Ç—É, —â–æ–± –º–æ–∂–Ω–∞ –±—É–ª–æ –≤–∏–±—Ä–∞—Ç–∏ —Ç–æ–π —Å–∞–º–∏–π —Ñ–∞–π–ª –∑–Ω–æ–≤—É
        } else if (file) { // –Ø–∫—â–æ —Ñ–∞–π–ª –≤–∏–±—Ä–∞–Ω–æ, –∞–ª–µ —Ü–µ –Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
            alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (JPEG, PNG, GIF).");
            uploadIndicator.style.display = 'none'; // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä, —è–∫—â–æ —Ñ–∞–π–ª –Ω–µ –ø—ñ–¥—Ö–æ–¥–∏—Ç—å
        }
      });
    }

    // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥—É –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è (—Ç–µ–∫—Å—Ç –∞–±–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è)
    function renderMessage(data) {
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message");
      messageDiv.dataset.messageId = data.messageId; // –î–æ–¥–∞—î–º–æ ID –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
      const colorClass = userColors[data.user];
      if (colorClass) messageDiv.classList.add(colorClass);

      // –í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Ü–∏—Ç–æ–≤–∞–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —è–∫—â–æ –≤–æ–Ω–æ —î
      if (data.replyTo) {
        const replyQuoteDiv = document.createElement('div');
        replyQuoteDiv.classList.add('message-reply-quote');
        
        const originalSender = document.createElement('strong');
        originalSender.textContent = data.replyTo.user;
        
        const originalText = document.createElement('span');
        originalText.textContent = `: ${data.replyTo.text}`; // –¢–µ–∫—Å—Ç —Ü–∏—Ç–∞—Ç–∏

        replyQuoteDiv.appendChild(originalSender);
        replyQuoteDiv.appendChild(originalText);
        
        // –î–æ–¥–∞—î–º–æ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∫–ª—ñ–∫–Ω—É—Ç–∏ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É –¥–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        replyQuoteDiv.onclick = () => scrollToMessage(data.replyTo.messageId);
        messageDiv.appendChild(replyQuoteDiv); // –î–æ–¥–∞—î–º–æ –±–ª–æ–∫ —Ü–∏—Ç–∞—Ç–∏ –ü–ï–†–ï–î –æ—Å–Ω–æ–≤–Ω–∏–º –≤–º—ñ—Å—Ç–æ–º
      }

      if (data.type === 'image' && data.image) {
        const img = document.createElement('img');
        img.src = data.image;
        img.alt = "–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤—ñ–¥ " + data.user;
        img.classList.add('chat-image-thumbnail');
        img.onclick = () => displayChatImageFull(data.image);
        const senderInfo = document.createElement('span');
        senderInfo.textContent = `${avatars[data.user] || "üë§"} ${data.user}: `;
        senderInfo.classList.add('message-sender', 'message-sender-image'); // –î–æ–¥–∞—î–º–æ –û–ë–ò–î–í–ê –∫–ª–∞—Å–∏
        messageDiv.appendChild(senderInfo);
        messageDiv.appendChild(img);
      } else {
        // –°—Ç–≤–æ—Ä—é—î–º–æ –æ–∫—Ä–µ–º—ñ –µ–ª–µ–º–µ–Ω—Ç–∏ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫–∞ —Ç–∞ —Ç–µ–∫—Å—Ç—É
        const senderInfo = document.createElement('span');
        senderInfo.textContent = `${avatars[data.user] || "üë§"} ${data.user}: `;
        senderInfo.classList.add('message-sender');

        const textContent = document.createElement('span');
        textContent.classList.add('message-text-content'); // –ö–ª–∞—Å –¥–ª—è –ª–µ–≥–∫–æ–≥–æ –¥–æ—Å—Ç—É–ø—É
        textContent.textContent = data.text;

        messageDiv.appendChild(senderInfo);
        messageDiv.appendChild(textContent);
      }

      const actionsDiv = document.createElement("div");
      actionsDiv.classList.add("message-actions");

      // –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –∫–Ω–æ–ø–æ–∫ (–∑–ª—ñ–≤–∞/—Å–ø—Ä–∞–≤–∞) –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∞–≤—Ç–æ—Ä–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
      if (data.user === "Baby üòé") { // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è Baby —Å–ø—Ä–∞–≤–∞, –∫–Ω–æ–ø–∫–∏ –∑–ª—ñ–≤–∞ –≤—ñ–¥ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        actionsDiv.classList.add("actions-left");
      } else if (data.user === "Pink Cloud ‚òÅÔ∏è") { // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è Cloud –∑–ª—ñ–≤–∞, –∫–Ω–æ–ø–∫–∏ —Å–ø—Ä–∞–≤–∞ –≤—ñ–¥ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        actionsDiv.classList.add("actions-right");
      }

      // –ö–Ω–æ–ø–∫–∞ "–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏" –¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –≤—Å—ñ—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
      const replyButton = document.createElement("button");
      replyButton.classList.add("action-btn", "reply-btn", "tooltip");
      replyButton.innerHTML = "&#8617;"; // –°–∏–º–≤–æ–ª –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
      replyButton.title = "–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏";
      replyButton.onclick = () => startReply(data.messageId, data.user, data.type === 'text' ? data.text : "–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è");

      // –ö–Ω–æ–ø–∫–∏ "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏" —Ç–∞ "–í–∏–¥–∞–ª–∏—Ç–∏" –¥–æ—Å—Ç—É–ø–Ω—ñ —Ç—ñ–ª—å–∫–∏ –¥–ª—è –≤–ª–∞—Å–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
      if (data.user === selectedNickname) {
        const editButton = document.createElement("button");
        editButton.classList.add("action-btn", "edit-btn", "tooltip");
        editButton.innerHTML = "&#9998;"; 
        editButton.title = "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏";
        editButton.onclick = () => startEditMessage(data.messageId, messageDiv, data.type === 'text' ? data.text : null);
        if (data.type !== 'text') editButton.style.display = 'none'; 

        const deleteButton = document.createElement("button");
        deleteButton.classList.add("action-btn", "delete-btn", "tooltip");
        deleteButton.innerHTML = "&#128465;"; 
        deleteButton.title = "–í–∏–¥–∞–ª–∏—Ç–∏";
        deleteButton.onclick = () => deleteMessage(data.messageId);

        actionsDiv.appendChild(deleteButton); // –ü–æ—Ä—è–¥–æ–∫: –í–∏–¥–∞–ª–∏—Ç–∏, –†–µ–¥–∞–≥—É–≤–∞—Ç–∏, –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏
        actionsDiv.appendChild(editButton);
      }
      actionsDiv.appendChild(replyButton); // –ö–Ω–æ–ø–∫–∞ "–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏" –¥–æ–¥–∞—î—Ç—å—Å—è –∑–∞–≤–∂–¥–∏ (–æ—Å—Ç–∞–Ω–Ω—å–æ—é –¥–ª—è —Å–≤–æ—ó—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å)
      messageDiv.appendChild(actionsDiv);

      return messageDiv; // –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ —Å—Ç–≤–æ—Ä–µ–Ω–∏–π –µ–ª–µ–º–µ–Ω—Ç –∑–∞–º—ñ—Å—Ç—å –¥–æ–¥–∞–≤–∞–Ω–Ω—è –π–æ–≥–æ –≤ —á–∞—Ç —Ç—É—Ç
    }

    function scrollToMessage(messageId) {
      const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
      if (messageElement) {
        messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        messageElement.classList.add('highlight-message'); // –¢–∏–º—á–∞—Å–æ–≤–æ –ø—ñ–¥—Å–≤—ñ—Ç–∏—Ç–∏
        setTimeout(() => messageElement.classList.remove('highlight-message'), 1500);
      }
    }
    function sendMessage() {
      const msgInput = document.getElementById("msgInput");
      const msg = msgInput.value.trim();
      if (msg && socket) {
        const messagePayload = { type: 'text', text: msg };
        if (currentReplyInfo) {
          messagePayload.replyTo = currentReplyInfo;
        }
        socket.emit("message", messagePayload);
        // –û—á–∏—â–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å —Ç–∞ —Ö–æ–≤–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –ø–µ—Ä–µ–≥–ª—è–¥
        cancelReply(); 
        msgInput.value = "";
      }
    }

    function scrollToBottom() {
      const chatBox = document.getElementById("chat");
      chatBox.scrollTop = chatBox.scrollHeight;
    }

        function playMusic(songSrc, buttonElement) {
      if (musicPlayer.src.includes(songSrc) && !musicPlayer.paused) {
        // –¢–∞ —Å–∞–º–∞ –ø—ñ—Å–Ω—è –≥—Ä–∞—î, —Å—Ç–∞–≤–∏–º–æ –Ω–∞ –ø–∞—É–∑—É
        musicPlayer.pause();
        buttonElement.classList.remove('playing');
        currentPlayingButton = null;
      } else if (musicPlayer.src.includes(songSrc) && musicPlayer.paused) {
        // –¢–∞ —Å–∞–º–∞ –ø—ñ—Å–Ω—è –Ω–∞ –ø–∞—É–∑—ñ, –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è
        musicPlayer.play()
          .then(() => {
            if (currentPlayingButton && currentPlayingButton !== buttonElement) {
              currentPlayingButton.classList.remove('playing');
            }
            buttonElement.classList.add('playing');
            currentPlayingButton = buttonElement;
          })
          .catch(error => console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è –∞—É–¥—ñ–æ:", error));
      } else {
        // –ù–æ–≤–∞ –ø—ñ—Å–Ω—è –∞–±–æ —ñ–Ω—à–∞ –≤–∏–±—Ä–∞–Ω–∞
        if (currentPlayingButton) {
          currentPlayingButton.classList.remove('playing');
        }
        
        musicPlayer.src = songSrc;
        currentSongSrc = songSrc;
        musicPlayer.play()
          .then(() => {
            buttonElement.classList.add('playing');
            currentPlayingButton = buttonElement;
          })
          .catch(error => {
            console.error("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –∞—É–¥—ñ–æ:", error);
            currentSongSrc = null;
          });
      }
    }

    musicPlayer.onended = function() {
      if (currentPlayingButton) {
        currentPlayingButton.classList.remove('playing');
        currentPlayingButton = null;
      }
      currentSongSrc = null;
    };

    // --- –ö–µ—Ä—É–≤–∞–Ω–Ω—è –≥—É—á–Ω—ñ—Å—Ç—é ---
    const volumeToggleButton = document.getElementById('volumeToggleButton');
    const volumeSlider = document.getElementById('volumeSlider');

    function updateVolumeIcon(volume) {
      if (volume === 0) {
        volumeToggleButton.textContent = 'üîá';
      } else if (volume <= 0.33) {
        volumeToggleButton.textContent = 'üîà';
      } else if (volume <= 0.66) {
        volumeToggleButton.textContent = 'üîâ';
      } else {
        volumeToggleButton.textContent = 'üîä';
      }
    }

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≥—É—á–Ω–æ—Å—Ç—ñ
    let initialVolume = parseFloat(localStorage.getItem('playerVolume'));
    if (isNaN(initialVolume) || initialVolume < 0 || initialVolume > 1) {
      initialVolume = 0.5; // –ì—É—á–Ω—ñ—Å—Ç—å –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º
    }
    musicPlayer.volume = initialVolume;
    volumeSlider.value = initialVolume;
    updateVolumeIcon(initialVolume);

    volumeToggleButton.addEventListener('click', () => {
      if (volumeSlider.style.display === 'none') {
        volumeSlider.style.display = 'inline-block'; // –ê–±–æ 'block' —á–∏ 'flex' –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –±–∞–∂–∞–Ω–æ–≥–æ –≤–∏–≥–ª—è–¥—É
      } else {
        volumeSlider.style.display = 'none';
      }
    });

    volumeSlider.addEventListener('input', function() {
      musicPlayer.volume = this.value;
      updateVolumeIcon(parseFloat(this.value));
      localStorage.setItem('playerVolume', this.value);
    });

    // –ó–∞–∫—Ä–∏–≤–∞—Ç–∏ —Å–ª–∞–π–¥–µ—Ä –≥—É—á–Ω–æ—Å—Ç—ñ, —è–∫—â–æ –∫–ª—ñ–∫–Ω—É—Ç–∏ –¥–µ—ñ–Ω–¥–µ (–æ–ø—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ)
    // document.addEventListener('click', function(event) {
    //   if (!volumeControl.contains(event.target) && volumeSlider.style.display !== 'none') {
    //     volumeSlider.style.display = 'none';
    //   }
    // });

    // --- –ì–∞–ª–µ—Ä–µ—è –∑–æ–±—Ä–∞–∂–µ–Ω—å ---
    const openGalleryBtn = document.getElementById('openGalleryBtn');
    const closeGalleryBtn = document.getElementById('closeGalleryBtn');
    const imageGalleryModal = document.getElementById('imageGalleryModal');
    const galleryImagesContainer = document.getElementById('galleryImagesContainer');
    const prevImageBtn = document.getElementById('prevImageBtn');
    const nextImageBtn = document.getElementById('nextImageBtn');
    const chatDisplayModal = document.getElementById('chatImageDisplayModal');
    const emojiToggleBtn = document.getElementById('emojiToggleBtn');
    const emojiPanel = document.getElementById('emojiPanel');
    const chatDisplayImg = document.getElementById('chatDisplayImage');
    const closeChatImageDisplayBtn = document.getElementById('closeChatImageDisplayModalBtn');

    function displayChatImageFull(imageSrc) {
      chatDisplayImg.src = imageSrc;
      chatDisplayModal.style.display = 'flex';
      chatDisplayModal.classList.remove('hide');
      chatDisplayModal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    if (closeChatImageDisplayBtn) {
      closeChatImageDisplayBtn.addEventListener('click', () => {
        chatDisplayModal.classList.remove('show');
        chatDisplayModal.classList.add('hide');
        setTimeout(() => {
          if (chatDisplayModal.classList.contains('hide')) {
            chatDisplayModal.style.display = 'none';
          }
          document.body.style.overflow = 'auto';
        }, 400); // –ß–∞—Å –º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ CSS –∞–Ω—ñ–º–∞—Ü—ñ—ó
      });
    }

    // –ó–ê–ú–Ü–ù–ò –¶–Ü –®–õ–Ø–•–ò –ù–ê –°–í–û–á –ó–û–ë–†–ê–ñ–ï–ù–ù–Ø –í –ü–ê–ü–¶–Ü 'img'
    const galleryImageSources = [
      'img/1.jpg',
      'img/2.jpg',
      'img/3.jpg',
      'img/4.jpg',
      'img/5.jpg',
      'img/6.jpg',
      'img/7.jpg',
      'img/8.jpg',
      'img/9.jpg',
      'img/10.jpg'
      // –î–æ–¥–∞–π –±—ñ–ª—å—à–µ —à–ª—è—Ö—ñ–≤ –¥–æ –∑–æ–±—Ä–∞–∂–µ–Ω—å —Ç—É—Ç
    ];
    let imagesInGalleryLoaded = false;

    function populateGallery() {
      if (imagesInGalleryLoaded) return;
      galleryImagesContainer.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç–∏ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ, —è–∫—â–æ —î
      galleryImageSources.forEach(src => {
        const img = document.createElement('img');
        img.src = src;
        img.alt = "–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ –≥–∞–ª–µ—Ä–µ—ó";
        galleryImagesContainer.appendChild(img);
      });
      imagesInGalleryLoaded = true;
    }

    openGalleryBtn.addEventListener('click', () => {
      populateGallery();
      imageGalleryModal.style.display = 'flex'; // –°–ø–æ—á–∞—Ç–∫—É —Ä–æ–±–∏–º–æ –±–ª–æ–∫ –≤–∏–¥–∏–º–∏–º
      imageGalleryModal.classList.remove('hide'); // –í–∏–¥–∞–ª–∏—Ç–∏ –∫–ª–∞—Å hide, —è–∫—â–æ –≤—ñ–Ω —î
      imageGalleryModal.classList.add('show');
      document.body.style.overflow = 'hidden'; // –ó–∞–ø–æ–±—ñ–≥—Ç–∏ –ø—Ä–æ–∫—Ä—É—Ç—Ü—ñ —Ñ–æ–Ω—É
    });

    closeGalleryBtn.addEventListener('click', () => {
      imageGalleryModal.classList.remove('show');
      imageGalleryModal.classList.add('hide');
      
      // –ó–∞—á–µ–∫–∞—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è –∞–Ω—ñ–º–∞—Ü—ñ—ó –ø–µ—Ä–µ–¥ —Ç–∏–º, —è–∫ –ø—Ä–∏—Ö–æ–≤–∞—Ç–∏ –µ–ª–µ–º–µ–Ω—Ç —ñ –≤—ñ–¥–Ω–æ–≤–∏—Ç–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫—É
      setTimeout(() => {
        // –Ø–∫—â–æ –≥–∞–ª–µ—Ä–µ—è –≤—Å–µ —â–µ –º–∞—î –∫–ª–∞—Å 'hide' (—Ç–æ–±—Ç–æ –Ω–µ –±—É–ª–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞ –∑–Ω–æ–≤—É –ø—ñ–¥ —á–∞—Å –∞–Ω—ñ–º–∞—Ü—ñ—ó)
        if (imageGalleryModal.classList.contains('hide')) {
          imageGalleryModal.style.display = 'none'; // –û—Å—Ç–∞—Ç–æ—á–Ω–æ –ø—Ä–∏—Ö–æ–≤—É—î–º–æ –µ–ª–µ–º–µ–Ω—Ç
        }
        document.body.style.overflow = 'auto'; // –í—ñ–¥–Ω–æ–≤–∏—Ç–∏ –ø—Ä–æ–∫—Ä—É—Ç–∫—É —Ñ–æ–Ω—É
      }, 400); // –ß–∞—Å –º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—Ç–∏ —Ç—Ä–∏–≤–∞–ª–æ—Å—Ç—ñ –∞–Ω—ñ–º–∞—Ü—ñ—ó fadeOutModal

    });

    prevImageBtn.addEventListener('click', () => {
      galleryImagesContainer.scrollBy({ left: -galleryImagesContainer.clientWidth, behavior: 'smooth' });
    });

    nextImageBtn.addEventListener('click', () => {
      galleryImagesContainer.scrollBy({ left: galleryImagesContainer.clientWidth, behavior: 'smooth' });
    });

    // --- –ü–∞–Ω–µ–ª—å –ï–º–æ–¥–∑—ñ ---
    const emojis = ['üòÄ', 'üòÇ', 'üòä', 'üòç', 'ü§î', 'üò¢', 'üò†', 'üëç', 'üëé', '‚ù§Ô∏è', 'üéâ', '‚ú®', 'üå∏', '‚òÅÔ∏è', 'üòé', 'üçÇ', 'üíñ', 'üå†', 'ü§ó', 'üåå', 'üòò', 'üòú', 'üòá', 'ü•≥', 'üò≠', 'üôè', 'üëÄ', 'üëã', 'üî•', 'üíØ'];

    function populateEmojiPanel() {
      emojis.forEach(emoji => {
        const emojiSpan = document.createElement('span');
        emojiSpan.textContent = emoji;
        emojiSpan.setAttribute('role', 'button'); // –î–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ
        emojiSpan.setAttribute('tabindex', '0');  // –î–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ
        emojiSpan.addEventListener('click', () => insertEmoji(emoji));
        emojiSpan.addEventListener('keydown', (e) => { // –î–ª—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—ñ –∑ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏
          if (e.key === 'Enter' || e.key === ' ') {
            insertEmoji(emoji);
          }
        });
        emojiPanel.appendChild(emojiSpan);
      });
    }

    function insertEmoji(emoji) {
      const msgInput = document.getElementById('msgInput');
      const start = msgInput.selectionStart;
      const end = msgInput.selectionEnd;
      const text = msgInput.value;
      msgInput.value = text.substring(0, start) + emoji + text.substring(end);
      msgInput.focus();
      msgInput.selectionStart = msgInput.selectionEnd = start + emoji.length;
      // –ú–æ–∂–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ö–æ–≤–∞—Ç–∏ –ø–∞–Ω–µ–ª—å –ø—ñ—Å–ª—è –≤–∏–±–æ—Ä—É:
      // emojiPanel.style.display = 'none';
    }

    emojiToggleBtn.addEventListener('click', (event) => {
      event.stopPropagation(); // –ó—É–ø–∏–Ω—è—î–º–æ —Å–ø–ª–∏–≤–∞–Ω–Ω—è –ø–æ–¥—ñ—ó, —â–æ–± –Ω–µ –∑–∞–∫—Ä–∏—Ç–∏ –ø–∞–Ω–µ–ª—å –æ–¥—Ä–∞–∑—É
      emojiPanel.style.display = emojiPanel.style.display === 'none' ? 'grid' : 'none';
    });

    document.addEventListener('click', (event) => {
      if (emojiPanel.style.display === 'grid' && !emojiPanel.contains(event.target) && event.target !== emojiToggleBtn) {
        emojiPanel.style.display = 'none';
      }
    });
    populateEmojiPanel(); // –ó–∞–ø–æ–≤–Ω—é—î–º–æ –ø–∞–Ω–µ–ª—å –µ–º–æ–¥–∑—ñ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ

    // --- –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ç–∞ –í–∏–¥–∞–ª–µ–Ω–Ω—è –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å ---

    function deleteMessage(messageId) {
      if (confirm("–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?")) {
        if (socket) {
          socket.emit('delete_message', { messageId });
        }
      }
    }

    function startEditMessage(messageId, messageDiv, currentText) {
      if (!currentText) return; 

      // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∂–µ –Ω–µ –π–¥–µ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ü—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
      if (messageDiv.querySelector('.edit-message-input')) {
        return;
      }

      const textContentElement = messageDiv.querySelector('.message-text-content');
      if (!textContentElement) {
        console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ .message-text-content –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≤:", messageDiv);
        return;
      }
      // –û–Ω–æ–≤–ª—é—î–º–æ currentText, —â–æ–± –≤—ñ–Ω —Ç–æ—á–Ω–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–≤ –≤–º—ñ—Å—Ç—É –µ–ª–µ–º–µ–Ω—Ç–∞, —è–∫–∏–π —Ä–µ–¥–∞–≥—É—î–º–æ
      currentText = textContentElement.textContent;

      // –•–æ–≤–∞—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π —Ç–µ–∫—Å—Ç–æ–≤–∏–π –µ–ª–µ–º–µ–Ω—Ç —Ç–∞ –∫–Ω–æ–ø–∫–∏ –¥—ñ–π
      textContentElement.style.display = 'none';
      const actionsDiv = messageDiv.querySelector('.message-actions');
      if (actionsDiv) {
        actionsDiv.style.display = 'none';
      }
      
      const input = document.createElement('textarea');
      input.classList.add('edit-message-input');
      input.value = currentText; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ç–µ–∫—Å—Ç –±–µ–∑ –ø—Ä–µ—Ñ—ñ–∫—Å—É
      input.rows = Math.max(1, Math.min(5, (currentText.match(/\n/g) || []).length + 1)); 
      input.onkeydown = (e) => { 
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          saveButton.click();
        } else if (e.key === 'Escape') {
          cancelButton.click();
        }
      };
      
      const saveButton = document.createElement('button');
      saveButton.textContent = '–ó–±–µ—Ä–µ–≥—Ç–∏';
      saveButton.classList.add('action-btn', 'save-edit-btn');
      saveButton.onclick = () => {
        const newText = input.value.trim();

        if (newText && newText !== currentText) {
          if (socket) {
            socket.emit('edit_message', { messageId, newText });
          }
        } // –Ø–∫—â–æ —Ç–µ–∫—Å—Ç –Ω–µ –∑–º—ñ–Ω–∏–≤—Å—è, –Ω—ñ—á–æ–≥–æ –Ω–µ —Ä–æ–±–∏–º–æ, –ø—Ä–æ—Å—Ç–æ –∑–∞–∫—Ä–∏–≤–∞—î–º–æ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è

        // –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –ø–æ–ª–µ –≤–≤–æ–¥—É —Ç–∞ –∫–Ω–æ–ø–∫–∏ –∑–±–µ—Ä–µ–≥—Ç–∏/—Å–∫–∞—Å—É–≤–∞—Ç–∏
        messageDiv.removeChild(saveButton);
        messageDiv.removeChild(cancelButton);
        messageDiv.removeChild(input);

        // –ü–æ–∫–∞–∑—É—î–º–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π —Ç–µ–∫—Å—Ç–æ–≤–∏–π –µ–ª–µ–º–µ–Ω—Ç (–π–æ–≥–æ –≤–º—ñ—Å—Ç –æ–Ω–æ–≤–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 'message_edited' –ø–æ–¥—ñ—é)
        textContentElement.style.display = '';
        if (actionsDiv) actionsDiv.style.display = 'flex'; // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫–∏ –¥—ñ–π
      };

      const cancelButton = document.createElement('button');
      cancelButton.textContent = '–°–∫–∞—Å—É–≤–∞—Ç–∏';
      cancelButton.classList.add('action-btn', 'cancel-edit-btn');
      cancelButton.onclick = () => {
        messageDiv.removeChild(saveButton);
        messageDiv.removeChild(cancelButton);
        messageDiv.removeChild(input);
        
        textContentElement.style.display = '';
        if (actionsDiv) actionsDiv.style.display = 'flex';
      };

      // –í—Å—Ç–∞–≤–ª—è—î–º–æ –ø–æ–ª–µ –≤–≤–æ–¥—É —Ç–∞ –∫–Ω–æ–ø–∫–∏ –ø—ñ—Å–ª—è –µ–ª–µ–º–µ–Ω—Ç–∞ –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫–∞ (—è–∫—â–æ –≤—ñ–Ω —î) –∞–±–æ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫
      const senderElement = messageDiv.querySelector('.message-sender');
      (senderElement || messageDiv.firstChild).insertAdjacentElement('afterend', input);
      input.insertAdjacentElement('afterend', saveButton); // –ö–Ω–æ–ø–∫–∏ –π–¥—É—Ç—å –ø—ñ—Å–ª—è –ø–æ–ª—è –≤–≤–æ–¥—É
      saveButton.insertAdjacentElement('afterend', cancelButton);
      input.focus();
      input.select(); // –í–∏–¥—ñ–ª—è—î–º–æ —Ç–µ–∫—Å—Ç –¥–ª—è –∑—Ä—É—á–Ω–æ—Å—Ç—ñ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è
    }

    // --- –í—ñ–¥–ø–æ–≤—ñ–¥—ñ –Ω–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è ---
    const replyPreviewDiv = document.getElementById('replyPreview');
    const replyPreviewUser = document.getElementById('replyPreviewUser');
    const replyPreviewText = document.getElementById('replyPreviewText');
    const cancelReplyBtn = document.getElementById('cancelReplyBtn');

    function startReply(messageId, user, text) {
      currentReplyInfo = {
        messageId: messageId,
        user: user,
        // –û–±—Ä—ñ–∑–∞—î–º–æ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É, —è–∫—â–æ –≤—ñ–Ω –∑–∞–¥–æ–≤–≥–∏–π
        text: text.length > 50 ? text.substring(0, 47) + "..." : text
      };

      replyPreviewUser.textContent = user;
      replyPreviewText.textContent = currentReplyInfo.text;
      replyPreviewDiv.style.display = 'flex';
      
      const msgInput = document.getElementById('msgInput');
      msgInput.focus(); // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª—ñ –≤–≤–æ–¥—É
    }

    function cancelReply() {
      currentReplyInfo = null;
      replyPreviewDiv.style.display = 'none';
    }

    if (cancelReplyBtn) {
      cancelReplyBtn.addEventListener('click', cancelReply);
    }
  </script>

</body>
</html>
