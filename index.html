<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ù–∞—à –≤–ª–∞—Å–Ω–∏–π —á–∞—Ç</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
</head>
<body>

  <!-- –ï–∫—Ä–∞–Ω –≤—Ö–æ–¥—É -->
  <div class="login-screen" id="loginScreen">
    <h2>–í—Ö—ñ–¥ —É —á–∞—Ç</h2>
    <input type="password" id="passwordInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å" />
    <div id="nicknameSelection" style="display: none;">
      <p>–í–∏–±–µ—Ä—ñ—Ç—å –Ω—ñ–∫–Ω–µ–π–º:</p>
      <button onclick="chooseNickname('Babyüòé')">Babyüòé</button>
      <button onclick="chooseNickname('Pink Cloud‚òÅ')">Pink Cloud‚òÅ</button>
    </div>
    <button onclick="checkPassword()">–£–≤—ñ–π—Ç–∏</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- –ß–∞—Ç -->
  <div class="chat-container" id="chatContainer" style="display: none;">
    <h1>üå∏ –ù–∞—à –∑ —Ç–æ–±–æ—é —á–∞—Ç –∫–≤—ñ—Ç–∫–æ üå∏</h1>
    <div id="chat" class="chat-box"></div>
    <textarea class="chat-input" id="msgInput" placeholder="–ù–∞–ø–∏—à–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." rows="4"></textarea>
    <button class="chat-button">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
    <div id="users-online">üü¢ –û–Ω–ª–∞–π–Ω: </div>
    <div id="typing-indicator" class="users-online"></div>
  </div>

  <script>
    let selectedNickname = null;
    let socket = null;

    function checkPassword() {
      const password = document.getElementById('passwordInput').value;
      if (password === "26060512") {
        document.getElementById('nicknameSelection').style.display = "block";
        document.getElementById('loginError').textContent = "";
      } else {
        document.getElementById('loginError').textContent = "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–∞—Ä–æ–ª—å.";
      }
    }

    function chooseNickname(nick) {
      selectedNickname = nick;
      document.getElementById('loginScreen').style.display = "none";
      document.getElementById('chatContainer').style.display = "flex";
      startChat();
    }

    function startChat() {
      socket = io("https://cloud-baby.onrender.com", {
        transports: ["websocket"]
      });

      socket.emit("register", selectedNickname); // –ø–µ—Ä–µ–¥–∞—î–º–æ –Ω—ñ–∫

      socket.on("chat_history", (messages) => {
        const chat = document.getElementById("chat");
        messages.forEach((data) => {
          const div = document.createElement("div");
          div.textContent = `${data.user}: ${data.text}`;
          div.classList.add("message");
          chat.appendChild(div);
        });
        scrollToBottom();
      });

      socket.on("message", (data) => {
        const chat = document.getElementById("chat");
        const div = document.createElement("div");
        div.classList.add("message");
        div.textContent = `${data.user}: ${data.text}`;
        chat.appendChild(div);
        scrollToBottom();
      });

      socket.on("users_online", (users) => {
        document.getElementById('users-online').textContent = "üü¢ –û–Ω–ª–∞–π–Ω: " + users.join(", ");
      });

      socket.on("typing", (data) => {
        const typingDiv = document.getElementById("typing-indicator");
        if (data.typing) {
          typingDiv.textContent = `${data.user} —à–æ—Å—å —Ç–∞–º —Ü—ñ–∫–∞–≤–µ–Ω—å–∫–µ –ø–∏—à–µ...–ª—é–±–ª—è—á–∏ —Ç–µ–±–µ –¥—É–∂–µ —Å–∏–ª—å–Ω–æ!`;
        } else {
          typingDiv.textContent = "";
        }
      });

      socket.emit("get_history");

      const msgInput = document.getElementById("msgInput");
      let typingTimeout;

      msgInput.addEventListener("input", () => {
        socket.emit("typing", true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.emit("typing", false);
        }, 2000);
      });

      msgInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      document.querySelector(".chat-button").addEventListener("click", sendMessage);
    }

    function sendMessage() {
      const msgInput = document.getElementById("msgInput");
      const msg = msgInput.value.trim();
      if (msg && socket) {
        socket.emit("message", msg);
        msgInput.value = "";
      }
    }

    function scrollToBottom() {
      const chatBox = document.getElementById("chat");
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  </script>

</body>
</html>
