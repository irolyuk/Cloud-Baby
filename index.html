<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paradise</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
</head>
<body>

  <!-- Ğ•ĞºÑ€Ğ°Ğ½ Ğ²Ñ…Ğ¾Ğ´Ñƒ -->
  <div class="login-screen" id="loginScreen">
    <h2>Ğ’Ñ…Ñ–Ğ´ Ñƒ Ğ¿Ğ°Ñ€Ğ°Ğ´Ğ°Ğ¹Ğ·</h2>
    <input type="password" id="passwordInput" placeholder="Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ" />
    <div id="nicknameSelection" style="display: none;">
      <p>Ğ’Ğ¸Ğ±ĞµÑ€Ğ¸ ÑĞ²Ñ–Ğ¹ Ğ½Ñ–ĞºĞ½ĞµĞ¹Ğ¼ Ğ¼Ğ°Ğ½ÑĞ½Ñ Ğ¼Ğ¾Ñ:</p>
      <button onclick="chooseNickname('Baby ğŸ˜')">Baby ğŸ˜</button>
      <button onclick="chooseNickname('Pink Cloud â˜ï¸')">Pink Cloud â˜ï¸</button>
    </div>
    <button id="loginButton" onclick="checkPassword()">Ğ£Ğ²Ñ–Ğ¹Ñ‚Ğ¸</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- Ğ§Ğ°Ñ‚ -->
  <div class="chat-container" id="chatContainer" style="display: none;">
    <h1>ğŸŒ¸ â¤ Rakhiv Paradise â¤ ğŸŒ¸</h1>
    <button id="openGalleryBtn" class="gallery-toggle-btn">ğŸ–¼ï¸</button>
    <div id="chat" class="chat-box"></div>
    <!-- ĞĞ¾Ğ²Ğ¸Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ´Ğ»Ñ Ñ–Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ğ° Ğ½Ğ°Ğ±Ğ¾Ñ€Ñƒ Ñ‚ĞµĞºÑÑ‚Ñƒ Ğ²ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñ– Ñ‡Ğ°Ñ‚Ñƒ -->
    <div id="chatTypingIndicator" class="typing-message-in-chat" style="visibility: hidden;"></div>
    <div class="media-controls-area">
      <!-- ĞŸÑ€Ğ¸Ğ¿ÑƒÑĞºĞ°Ñ”Ğ¼Ğ¾, Ñ‰Ğ¾ Ñ‚ÑƒÑ‚ Ğ¼Ğ¾Ğ¶ÑƒÑ‚ÑŒ Ğ±ÑƒÑ‚Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´Ğ»Ñ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñƒ Ğ¼ÑƒĞ·Ğ¸ĞºĞ¸, ÑĞºÑ‰Ğ¾ Ğ²Ğ¾Ğ½Ğ¸ Ñ” -->
      <div class="items">
        <!-- ĞŸÑ€Ğ¸ĞºĞ»Ğ°Ğ´ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¼ÑƒĞ·Ğ¸ĞºĞ¸, Ğ´Ğ¾Ğ´Ğ°Ğ¹Ñ‚Ğµ ÑĞ²Ğ¾Ñ—, ÑĞºÑ‰Ğ¾ Ğ¿Ğ¾Ñ‚Ñ€Ñ–Ğ±Ğ½Ğ¾ -->
        <!-- <button class="item-btn" onclick="playMusic('audio/your-song.mp3', this)">ğŸµ ĞĞ°Ğ·Ğ²Ğ° ĞŸÑ–ÑĞ½Ñ–</button> -->
        <button class="item-btn" onclick="playMusic('audio/Autumn-love.m4a', this)">ğŸ‚Ğ›ÑĞ±Ğ¾Ğ² ÑĞº Ğ¾ÑÑ–Ğ½ÑŒğŸ‚</button>
        <button class="item-btn" onclick="playMusic('audio/Bounty.mp3', this)">ğŸ’–BountyğŸ’–</button>
        <button class="item-btn" onclick="playMusic('audio/Drevo.mp3', this)">ğŸŒ Ğ¡Ğ¼Ğ°Ñ€Ğ°Ğ³Ğ´Ğ¾Ğ²Ğµ Ğ½ĞµĞ±Ğ¾ğŸŒ </button>
        <button class="item-btn" onclick="playMusic('audio/MBreeze.mp3', this)">ğŸ¤—ĞšĞ¾Ğ¶ĞµĞ½ Ğ´ĞµĞ½ÑŒğŸ¤—</button>
        <button class="item-btn" onclick="playMusic('audio/SoulScream.mp3', this)">ğŸ¥°ĞšÑ€Ğ¸Ğº Ğ² Ğ¿ÑƒÑÑ‚Ğ¾Ñ‚ÑƒğŸ¥°</button>
        <button class="item-btn" onclick="playMusic('audio/WhenYouSmile.mp3', this)">ğŸ˜ĞšĞ¾Ğ»Ğ¸ Ñ‚Ğ¸ Ğ¿Ğ¾ÑĞ¼Ñ–Ñ…Ğ°Ñ”ÑˆÑÑğŸ˜</button>
        <button class="item-btn" onclick="playMusic('audio/song7.mp3', this)">ğŸµ ĞŸÑ–ÑĞ½Ñ 7</button> 
      </div>
      <div class="volume-control">
        <button id="volumeToggleButton" class="item-btn">ğŸ”Š</button>
        <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.01" value="0.5" style="display: none;">
      </div>
    </div>
    <!-- Ğ‘Ğ»Ğ¾Ğº Ğ´Ğ»Ñ Ğ²Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¿Ğ¾Ğ¿ĞµÑ€ĞµĞ´Ğ½ÑŒĞ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ĞµĞ³Ğ»ÑĞ´Ñƒ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ñ– - ĞŸĞ•Ğ Ğ•ĞœĞ†Ğ©Ğ•ĞĞ Ğ¡Ğ®Ğ”Ğ˜ -->
    <div id="replyPreview" class="reply-preview" style="display: none;">
      <div class="reply-preview-content"><strong id="replyPreviewUser"></strong>: <span id="replyPreviewText"></span></div>
      <button id="cancelReplyBtn" class="cancel-reply-btn">&times;</button>
    </div>
    <div class="input-controls">
      <textarea class="chat-input" id="msgInput" placeholder="ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ..." rows="1"></textarea>
      <button id="emojiToggleBtn" class="emoji-toggle-btn">ğŸ˜Š</button>
      <input type="file" id="imageInput" accept="image/*" style="display: none;">
      <button id="attachImageBtn" class="attach-btn">ğŸ“</button>
      <button class="chat-button">ğŸ’¬</button>
      <div id="emojiPanel" class="emoji-panel" style="display: none;">
        <!-- Ğ•Ğ¼Ğ¾Ğ´Ğ·Ñ– Ğ±ÑƒĞ´ÑƒÑ‚ÑŒ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ñ– ÑÑĞ´Ğ¸ Ğ·Ğ° Ğ´Ğ¾Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ¾Ñ JavaScript -->
      </div>
    </div>
    <div class="status-messages-container">
      <div id="users-online" class="users-online"></div>      
      <div id="imageUploadIndicator" class="upload-indicator" style="display: none;">Ğ’Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ... ğŸ–¼ï¸</div>
    </div>
  </div>

  <!-- ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğµ Ğ²Ñ–ĞºĞ½Ğ¾ Ğ´Ğ»Ñ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½ÑŒ Ğ· Ñ‡Ğ°Ñ‚Ñƒ -->
  <div id="chatImageDisplayModal" class="gallery-modal" style="display: none;">
    <button id="closeChatImageDisplayModalBtn" class="gallery-close-btn">&times;</button>
    <div class="gallery-content">
      <img id="chatDisplayImage" src="" alt="Ğ—Ğ±Ñ–Ğ»ÑŒÑˆĞµĞ½Ğµ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ· Ñ‡Ğ°Ñ‚Ñƒ" style="max-width: 90vw; max-height: 90vh; object-fit: contain;" />
    </div>
  </div>

  <!-- ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğµ Ğ²Ñ–ĞºĞ½Ğ¾ Ğ³Ğ°Ğ»ĞµÑ€ĞµÑ— -->
  <div id="imageGalleryModal" class="gallery-modal" style="display: none;">
    <button id="closeGalleryBtn" class="gallery-close-btn">&times;</button>
    <div class="gallery-content">
      <button id="prevImageBtn" class="gallery-nav-btn prev-btn" aria-label="Previous image">&lt;</button>
      <div class="gallery-images-container" id="galleryImagesContainer">
        <!-- Ğ—Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ±ÑƒĞ´ÑƒÑ‚ÑŒ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ñ– ÑÑĞ´Ğ¸ Ğ·Ğ° Ğ´Ğ¾Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ¾Ñ JavaScript -->
      </div>
      <button id="nextImageBtn" class="gallery-nav-btn next-btn" aria-label="Next image">&gt;</button>
    </div>
  </div>
  <script>
    let selectedNickname = null;
    let socket = null;
    // Player and related variables
    const musicPlayer = new Audio();
    let currentPlayingButton = null;
    let currentReplyInfo = null; // Ğ”Ğ»Ñ Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ğ½Ğ½Ñ Ñ–Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ñ–Ñ— Ğ¿Ñ€Ğ¾ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ, Ğ½Ğ° ÑĞºĞµ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ñ”Ğ¼Ğ¾
    let currentaudiorc = null;

    // DOM Element References - Initialized once the script loads
    // Login Screen
    const loginScreen = document.getElementById('loginScreen');
    const passwordInput = document.getElementById('passwordInput');
    const nicknameSelection = document.getElementById('nicknameSelection');
    const loginButton = document.getElementById('loginButton'); 
    const loginError = document.getElementById('loginError');
    const chatContainer = document.getElementById('chatContainer');

    // Chat Area
    const chat = document.getElementById('chat');
    const chatTypingIndicator = document.getElementById('chatTypingIndicator');
    const msgInput = document.getElementById('msgInput');
    const emojiToggleBtn = document.getElementById('emojiToggleBtn');
    const imageInput = document.getElementById('imageInput');
    const attachImageBtn = document.getElementById('attachImageBtn');
    const emojiPanel = document.getElementById('emojiPanel');
    const usersOnlineDiv = document.getElementById('users-online');
    const imageUploadIndicator = document.getElementById('imageUploadIndicator');

    // Reply Functionality
    const replyPreviewDiv = document.getElementById('replyPreview');
    const replyPreviewUser = document.getElementById('replyPreviewUser');
    const replyPreviewText = document.getElementById('replyPreviewText');
    const cancelReplyBtn = document.getElementById('cancelReplyBtn');

    // Modals and Gallery
    const openGalleryBtn = document.getElementById('openGalleryBtn');
    const closeGalleryBtn = document.getElementById('closeGalleryBtn');
    const imageGalleryModal = document.getElementById('imageGalleryModal');
    const galleryImagesContainer = document.getElementById('galleryImagesContainer');
    const prevImageBtn = document.getElementById('prevImageBtn');
    const nextImageBtn = document.getElementById('nextImageBtn');
    const chatImageDisplayModal = document.getElementById('chatImageDisplayModal');
    const chatDisplayImage = document.getElementById('chatDisplayImage'); 
    const closeChatImageDisplayModalBtn = document.getElementById('closeChatImageDisplayModalBtn');

    // Media Controls
    const volumeToggleButton = document.getElementById('volumeToggleButton');
    const volumeSlider = document.getElementById('volumeSlider');

    // Global Constants
    const avatars = {
     "Baby ğŸ˜": "ğŸ˜",
     "Pink Cloud â˜ï¸": "â˜ï¸"
    };
    
    const userColors = {
     "Baby ğŸ˜": "message-baby",
     "Pink Cloud â˜ï¸": "message-cloud"
    };

    function checkPassword() {
      const passwordValue = passwordInput.value; // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñƒ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñƒ
      if (passwordValue === "26060512") {
        nicknameSelection.style.display = "block"; // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñƒ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñƒ
        passwordInput.style.display = "none"; 
        loginButton.style.display = "none";   // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñƒ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñƒ
        loginError.textContent = ""; // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñƒ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñƒ
      } else {
        loginError.textContent = "ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¸Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ."; // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñƒ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñƒ
      }
    }

    function chooseNickname(nick) {
      selectedNickname = nick;
      loginScreen.style.display = "none"; // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñƒ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñƒ
      chatContainer.style.display = "flex"; // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñƒ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñƒ
      startChat();
    }

    function startChat() {
      socket = io("https://cloud-baby.onrender.com", {
        transports: ["websocket"]
      });

      // chat Ğ²Ğ¶Ğµ Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑˆĞµĞ½Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾
      socket.emit("register", selectedNickname); // Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ”Ğ¼Ğ¾ Ğ½Ñ–Ğº


      socket.on("message", (data) => { // ĞĞ±Ñ€Ğ¾Ğ±Ğ½Ğ¸Ğº Ğ½Ğ¾Ğ²Ğ¸Ñ… Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½ÑŒ
        const messageElement = renderMessage(data); 
        chat.appendChild(messageElement);
        scrollToBottom();
      });

      socket.on('message_edited', (data) => {
        const messageDiv = document.querySelector(`.message[data-message-id="${data.messageId}"]`);
        if (messageDiv) {
          const textContentElement = messageDiv.querySelector('.message-text-content');
          if (textContentElement) {
            textContentElement.textContent = data.newText; 

            let editedMark = messageDiv.querySelector('.edited-indicator');
            if (!editedMark) {
              editedMark = document.createElement('span');
              editedMark.classList.add('edited-indicator');
              editedMark.style.fontSize = '0.8em'; 
              editedMark.style.marginLeft = '5px'; 
              editedMark.textContent = '(Ğ²Ñ–Ğ´Ñ€ĞµĞ´Ğ°Ğ³Ğ¾Ğ²Ğ°Ğ½Ğ¾)';
              textContentElement.insertAdjacentElement('afterend', editedMark);
            }
          }
        }
      });

      socket.on('message_deleted', (data) => {
        const messageDiv = document.querySelector(`.message[data-message-id="${data.messageId}"]`);
        if (messageDiv) {
          messageDiv.remove();
        }
      });

      socket.on("chat_history", (messages) => { 
        messages.forEach(data => {
          const messageElement = renderMessage(data); 
          chat.appendChild(messageElement);
        });
        scrollToBottom();
      });

      socket.on("users_online", (users) => {
        // usersOnlineDiv Ğ²Ğ¶Ğµ Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑˆĞµĞ½Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾
        let displayString = "";

        const hasBaby = users.includes("Baby ğŸ˜");
        const hasCloud = users.includes("Pink Cloud â˜ï¸");

        if (hasBaby && hasCloud) {
          displayString = `
            <div class="finger-lightning-container">
              <div class="finger left">ğŸ‘‰</div>
              <div class="lightning"></div>
              <div class="finger right">ğŸ‘ˆ</div>
            </div>
          `;
        } else if (hasBaby) {
          displayString = `<div class="finger-lightning-container"><div>ğŸ‘‰</div></div>`;
        } else if (hasCloud) {
          displayString = `<div class="finger-lightning-container"><div>ğŸ‘ˆ</div></div>`;
        }
        
        usersOnlineDiv.innerHTML = displayString || "ĞÑ–ĞºĞ¾Ğ³Ğ¾ Ğ½ĞµĞ¼Ğ°Ñ” Ğ² Ğ¼ĞµÑ€ĞµĞ¶Ñ–";
      });

      socket.on("typing", (data) => {
        // chatTypingIndicator Ğ²Ğ¶Ğµ Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑˆĞµĞ½Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾
        if (data.typing) {          
          const userAvatar = avatars[data.user] || "ğŸ‘¤"; 
          chatTypingIndicator.textContent = `${userAvatar} ${data.user} ÑˆĞ¾ÑÑŒ Ñ‚Ğ°Ğ¼ Ñ†Ñ–ĞºĞ°Ğ²ĞµĞ½ÑŒĞºĞµ Ğ¿Ğ¸ÑˆĞµ...Ğ»ÑĞ±Ğ»ÑÑ‡Ğ¸ Ñ‚ĞµĞ±Ğµ Ğ´ÑƒĞ¶Ğµ ÑĞ¸Ğ»ÑŒĞ½Ğ¾!`;
          chatTypingIndicator.style.visibility = 'visible';
          scrollToBottom(); 
        } else {
          chatTypingIndicator.style.visibility = 'hidden';
        }
      });


      socket.emit("get_history");

      // msgInput Ğ²Ğ¶Ğµ Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑˆĞµĞ½Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾
      let typingTimeout;

      msgInput.addEventListener("input", () => {
        socket.emit("typing", true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.emit("typing", false);
        }, 2000);
      });

      msgInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      document.querySelector(".chat-button").addEventListener("click", () => sendMessage());
      
      // attachImageBtn Ñ‚Ğ° imageInput Ğ²Ğ¶Ğµ Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑˆĞµĞ½Ñ– Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾

      attachImageBtn.addEventListener('click', () => {
        imageInput.click(); 
      });

      imageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
          // imageUploadIndicator Ğ²Ğ¶Ğµ Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑˆĞµĞ½Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾
          imageUploadIndicator.style.display = 'block'; 

          const reader = new FileReader();
          reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
              const canvas = document.createElement('canvas');
              const MAX_WIDTH = 800; 
              const MAX_HEIGHT = 600; 
              let width = img.width;
              let height = img.height;

              if (width > height) {
                if (width > MAX_WIDTH) {
                  height *= MAX_WIDTH / width;
                  width = MAX_WIDTH;
                }
              } else {
                if (height > MAX_HEIGHT) {
                  width *= MAX_HEIGHT / height;
                  height = MAX_HEIGHT;
                }
              }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              const compressedImageDataUrl = canvas.toDataURL('image/jpeg', 0.9); 

              socket.emit("message", { type: 'image', image: compressedImageDataUrl }, () => {
                imageUploadIndicator.style.display = 'none';
              });
            }
            img.src = e.target.result; 
          }
          reader.readAsDataURL(file);
          imageInput.value = ''; 
        } else if (file) { 
            alert("Ğ‘ÑƒĞ´ÑŒ Ğ»Ğ°ÑĞºĞ°, Ğ²Ğ¸Ğ±ĞµÑ€Ñ–Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ» Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ (JPEG, PNG, GIF).");
            imageUploadIndicator.style.display = 'none'; 
        }
      });
    }

    function renderMessage(data) {
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message");
      messageDiv.dataset.messageId = data.messageId; 
      const colorClass = userColors[data.user];
      if (colorClass) messageDiv.classList.add(colorClass);

      if (data.replyTo) {
        const replyQuoteDiv = document.createElement('div');
        replyQuoteDiv.classList.add('message-reply-quote');
        
        const originalSender = document.createElement('strong');
        originalSender.textContent = data.replyTo.user;
        // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ ĞºĞ»Ğ°Ñ Ğ´Ğ»Ñ ĞºĞ¾Ğ»ÑŒĞ¾Ñ€Ñƒ Ñ–Ğ¼ĞµĞ½Ñ– Ğ² Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ñ–
        if (data.replyTo.user === "Baby ğŸ˜") {
            originalSender.classList.add('reply-quote-user-baby-color');
        } else if (data.replyTo.user === "Pink Cloud â˜ï¸") {
            originalSender.classList.add('reply-quote-user-cloud-color');
        }
        
        const originalText = document.createElement('span');
        originalText.textContent = `: ${data.replyTo.text}`; 

        replyQuoteDiv.appendChild(originalSender);
        replyQuoteDiv.appendChild(originalText);
        
        replyQuoteDiv.onclick = () => scrollToMessage(data.replyTo.messageId);
        messageDiv.appendChild(replyQuoteDiv); 
      }

      if (data.type === 'image' && data.image) {
        const img = document.createElement('img');
        img.src = data.image;
        img.alt = "Ğ—Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ²Ñ–Ğ´ " + data.user;
        img.classList.add('chat-image-thumbnail');
        img.onclick = () => displayChatImageFull(data.image);
        const senderInfo = document.createElement('span');
        senderInfo.textContent = `${avatars[data.user] || "ğŸ‘¤"} ${data.user}: `;
        senderInfo.classList.add('message-sender', 'message-sender-image'); 
        messageDiv.appendChild(senderInfo);
        messageDiv.appendChild(img);
      } else {
        const senderInfo = document.createElement('span');
        senderInfo.textContent = `${avatars[data.user] || "ğŸ‘¤"} ${data.user}: `;
        senderInfo.classList.add('message-sender');

        const textContent = document.createElement('span');
        textContent.classList.add('message-text-content'); 
        textContent.textContent = data.text;

        messageDiv.appendChild(senderInfo);
        messageDiv.appendChild(textContent);
      }

      const actionsDiv = document.createElement("div");
      actionsDiv.classList.add("message-actions");

      if (data.user === "Baby ğŸ˜") { 
        actionsDiv.classList.add("actions-left");
      } else if (data.user === "Pink Cloud â˜ï¸") { 
        actionsDiv.classList.add("actions-right");
      }

      const replyButton = document.createElement("button");
      replyButton.classList.add("action-btn", "reply-btn", "tooltip");
      replyButton.innerHTML = "&#8617;"; 
      replyButton.title = "Ğ’Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–ÑÑ‚Ğ¸";
      replyButton.onclick = () => startReply(data.messageId, data.user, data.type === 'text' ? data.text : "Ğ—Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ");

      if (data.user === selectedNickname) {
        const editButton = document.createElement("button");
        editButton.classList.add("action-btn", "edit-btn", "tooltip");
        editButton.innerHTML = "&#9998;"; 
        editButton.title = "Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸";
        editButton.onclick = () => startEditMessage(data.messageId, messageDiv, data.type === 'text' ? data.text : null);
        if (data.type !== 'text') editButton.style.display = 'none'; 

        const deleteButton = document.createElement("button");
        deleteButton.classList.add("action-btn", "delete-btn", "tooltip");
        deleteButton.innerHTML = "&#128465;"; 
        deleteButton.title = "Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸";
        deleteButton.onclick = () => deleteMessage(data.messageId);

        actionsDiv.appendChild(deleteButton); 
        actionsDiv.appendChild(editButton);
      }
      actionsDiv.appendChild(replyButton); 
      messageDiv.appendChild(actionsDiv);

      return messageDiv; 
    }

    function scrollToMessage(messageId) {
      const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
      if (messageElement) {
        messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        messageElement.classList.add('highlight-message'); 
        setTimeout(() => messageElement.classList.remove('highlight-message'), 1500);
      }
    }
    function sendMessage() {
      // msgInput Ğ²Ğ¶Ğµ Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑˆĞµĞ½Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾
      const msg = msgInput.value.trim();
      if (msg && socket) {
        const messagePayload = { type: 'text', text: msg };
        if (currentReplyInfo) {
          messagePayload.replyTo = currentReplyInfo;
        }
        socket.emit("message", messagePayload);
        cancelReply(); 
        msgInput.value = "";
      }
    }

    function scrollToBottom() {
      // chat (chatBox) Ğ²Ğ¶Ğµ Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑˆĞµĞ½Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾
      chat.scrollTop = chat.scrollHeight;
    }

        function playMusic(audiorc, buttonElement) {
      if (musicPlayer.src.includes(audiorc) && !musicPlayer.paused) {
        musicPlayer.pause();
        buttonElement.classList.remove('playing');
        currentPlayingButton = null;
      } else if (musicPlayer.src.includes(audiorc) && musicPlayer.paused) {
        musicPlayer.play()
          .then(() => {
            if (currentPlayingButton && currentPlayingButton !== buttonElement) {
              currentPlayingButton.classList.remove('playing');
            }
            buttonElement.classList.add('playing');
            currentPlayingButton = buttonElement;
          })
          .catch(error => console.error("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ²Ğ¶ĞµĞ½Ğ½Ñ Ğ°ÑƒĞ´Ñ–Ğ¾:", error));
      } else {
        if (currentPlayingButton) {
          currentPlayingButton.classList.remove('playing');
        }
        
        musicPlayer.src = audiorc;
        currentaudiorc = audiorc;
        musicPlayer.play()
          .then(() => {
            buttonElement.classList.add('playing');
            currentPlayingButton = buttonElement;
          })
          .catch(error => {
            console.error("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ²Ñ–Ğ´Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°ÑƒĞ´Ñ–Ğ¾:", error);
            currentaudiorc = null;
          });
      }
    }

    musicPlayer.onended = function() {
      if (currentPlayingButton) {
        currentPlayingButton.classList.remove('playing');
        currentPlayingButton = null;
      }
      currentaudiorc = null;
    };

    // volumeToggleButton Ñ‚Ğ° volumeSlider Ğ²Ğ¶Ğµ Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑˆĞµĞ½Ñ– Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾

    function updateVolumeIcon(volume) {
      if (volume === 0) {
        volumeToggleButton.textContent = 'ğŸ”‡';
      } else if (volume <= 0.33) {
        volumeToggleButton.textContent = 'ğŸ”ˆ';
      } else if (volume <= 0.66) {
        volumeToggleButton.textContent = 'ğŸ”‰';
      } else {
        volumeToggleButton.textContent = 'ğŸ”Š';
      }
    }

    let initialVolume = parseFloat(localStorage.getItem('playerVolume'));
    if (isNaN(initialVolume) || initialVolume < 0 || initialVolume > 1) {
      initialVolume = 0.5; 
    }
    musicPlayer.volume = initialVolume;
    volumeSlider.value = initialVolume;
    updateVolumeIcon(initialVolume);

    volumeToggleButton.addEventListener('click', () => {
      if (volumeSlider.style.display === 'none') {
        volumeSlider.style.display = 'inline-block'; 
      } else {
        volumeSlider.style.display = 'none';
      }
    });

    volumeSlider.addEventListener('input', function() {
      musicPlayer.volume = this.value;
      updateVolumeIcon(parseFloat(this.value));
      localStorage.setItem('playerVolume', this.value);
    });

    // openGalleryBtn, closeGalleryBtn, imageGalleryModal, galleryImagesContainer,
    // prevImageBtn, nextImageBtn, chatImageDisplayModal (ÑĞº chatDisplayModal), 
    // emojiToggleBtn, emojiPanel, chatDisplayImage (ÑĞº chatDisplayImg), 
    // closeChatImageDisplayModalBtn (ÑĞº closeChatImageDisplayBtn) Ğ²Ğ¶Ğµ Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑˆĞµĞ½Ñ– Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾

    function displayChatImageFull(imageSrc) {
      chatDisplayImage.src = imageSrc; // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñƒ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñƒ
      chatImageDisplayModal.style.display = 'flex'; // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñƒ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñƒ
      chatImageDisplayModal.classList.remove('hide');
      chatImageDisplayModal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    if (closeChatImageDisplayModalBtn) { // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñƒ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñƒ
      closeChatImageDisplayModalBtn.addEventListener('click', () => {
        chatImageDisplayModal.classList.remove('show'); // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ñƒ Ğ·Ğ¼Ñ–Ğ½Ğ½Ñƒ
        chatImageDisplayModal.classList.add('hide');
        setTimeout(() => {
          if (chatImageDisplayModal.classList.contains('hide')) {
            chatImageDisplayModal.style.display = 'none';
          }
          document.body.style.overflow = 'auto';
        }, 400); 
      });
    }

    const galleryImageSources = [
      'img/1.jpg', 'img/2.jpg', 'img/3.jpg', 'img/4.jpg', 'img/5.jpg',
      'img/6.jpg', 'img/7.jpg', 'img/8.jpg', 'img/9.jpg', 'img/10.jpg'
    ];
    let imagesInGalleryLoaded = false;

    function populateGallery() {
      if (imagesInGalleryLoaded) return;
      galleryImagesContainer.innerHTML = ''; 
      galleryImageSources.forEach(src => {
        const img = document.createElement('img');
        img.src = src;
        img.alt = "Ğ—Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ· Ğ³Ğ°Ğ»ĞµÑ€ĞµÑ—";
        galleryImagesContainer.appendChild(img);
      });
      imagesInGalleryLoaded = true;
    }

    openGalleryBtn.addEventListener('click', () => {
      populateGallery();
      imageGalleryModal.style.display = 'flex'; 
      imageGalleryModal.classList.remove('hide'); 
      imageGalleryModal.classList.add('show');
      document.body.style.overflow = 'hidden'; 
    });

    closeGalleryBtn.addEventListener('click', () => {
      imageGalleryModal.classList.remove('show');
      imageGalleryModal.classList.add('hide');
      
      setTimeout(() => {
        if (imageGalleryModal.classList.contains('hide')) {
          imageGalleryModal.style.display = 'none'; 
        }
        document.body.style.overflow = 'auto'; 
      }, 400); 

    });

    prevImageBtn.addEventListener('click', () => {
      galleryImagesContainer.scrollBy({ left: -galleryImagesContainer.clientWidth, behavior: 'smooth' });
    });

    nextImageBtn.addEventListener('click', () => {
      galleryImagesContainer.scrollBy({ left: galleryImagesContainer.clientWidth, behavior: 'smooth' });
    });

    const emojis = ['ğŸ˜€', 'ğŸ˜‚', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜¢', 'ğŸ˜ ', 'ğŸ‘', 'ğŸ‘', 'â¤ï¸', 'ğŸ‰', 'âœ¨', 'ğŸŒ¸', 'â˜ï¸', 'ğŸ˜', 'ğŸ‚', 'ğŸ’–', 'ğŸŒ ', 'ğŸ¤—', 'ğŸŒŒ', 'ğŸ˜˜', 'ğŸ˜œ', 'ğŸ˜‡', 'ğŸ¥³', 'ğŸ˜­', 'ğŸ™', 'ğŸ‘€', 'ğŸ‘‹', 'ğŸ”¥', 'ğŸ’¯'];

    function populateEmojiPanel() {
      emojis.forEach(emoji => {
        const emojiSpan = document.createElement('span');
        emojiSpan.textContent = emoji;
        emojiSpan.setAttribute('role', 'button'); 
        emojiSpan.setAttribute('tabindex', '0');  
        emojiSpan.addEventListener('click', () => insertEmoji(emoji));
        emojiSpan.addEventListener('keydown', (e) => { 
          if (e.key === 'Enter' || e.key === ' ') {
            insertEmoji(emoji);
          }
        });
        emojiPanel.appendChild(emojiSpan);
      });
    }

    function insertEmoji(emoji) {
      // msgInput Ğ²Ğ¶Ğµ Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑˆĞµĞ½Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾
      const start = msgInput.selectionStart;
      const end = msgInput.selectionEnd;
      const text = msgInput.value;
      msgInput.value = text.substring(0, start) + emoji + text.substring(end);
      msgInput.focus();
      msgInput.selectionStart = msgInput.selectionEnd = start + emoji.length;
    }

    emojiToggleBtn.addEventListener('click', (event) => {
      event.stopPropagation(); 
      emojiPanel.style.display = emojiPanel.style.display === 'none' ? 'grid' : 'none';
    });

    document.addEventListener('click', (event) => {
      if (emojiPanel.style.display === 'grid' && !emojiPanel.contains(event.target) && event.target !== emojiToggleBtn) {
        emojiPanel.style.display = 'none';
      }
    });
    populateEmojiPanel(); 

    function deleteMessage(messageId) {
      if (confirm("Ğ’Ğ¸ Ğ²Ğ¿ĞµĞ²Ğ½ĞµĞ½Ñ–, Ñ‰Ğ¾ Ñ…Ğ¾Ñ‡ĞµÑ‚Ğµ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ñ†Ğµ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ?")) {
        if (socket) {
          socket.emit('delete_message', { messageId });
        }
      }
    }

    function startEditMessage(messageId, messageDiv, currentText) {
      if (!currentText) return; 

      if (messageDiv.querySelector('.edit-message-input')) {
        return;
      }

      const textContentElement = messageDiv.querySelector('.message-text-content');
      if (!textContentElement) {
        console.error("ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ·Ğ½Ğ°Ğ¹Ñ‚Ğ¸ .message-text-content Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ²:", messageDiv);
        return;
      }
      currentText = textContentElement.textContent;

      textContentElement.style.display = 'none';
      const actionsDiv = messageDiv.querySelector('.message-actions');
      if (actionsDiv) {
        actionsDiv.style.display = 'none';
      }
      
      const input = document.createElement('textarea');
      input.classList.add('edit-message-input');
      input.value = currentText; 
      input.rows = Math.max(1, Math.min(5, (currentText.match(/\n/g) || []).length + 1)); 
      input.onkeydown = (e) => { 
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          saveButton.click();
        } else if (e.key === 'Escape') {
          cancelButton.click();
        }
      };
      
      const saveButton = document.createElement('button');
      saveButton.textContent = 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸';
      saveButton.classList.add('action-btn', 'save-edit-btn');
      saveButton.onclick = () => {
        const newText = input.value.trim();

        if (newText && newText !== currentText) {
          if (socket) {
            socket.emit('edit_message', { messageId, newText });
          }
        } 
        messageDiv.removeChild(saveButton);
        messageDiv.removeChild(cancelButton);
        messageDiv.removeChild(input);

        textContentElement.style.display = '';
        if (actionsDiv) actionsDiv.style.display = 'flex'; 
      };

      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸';
      cancelButton.classList.add('action-btn', 'cancel-edit-btn');
      cancelButton.onclick = () => {
        messageDiv.removeChild(saveButton);
        messageDiv.removeChild(cancelButton);
        messageDiv.removeChild(input);
        
        textContentElement.style.display = '';
        if (actionsDiv) actionsDiv.style.display = 'flex';
      };

      const senderElement = messageDiv.querySelector('.message-sender');
      (senderElement || messageDiv.firstChild).insertAdjacentElement('afterend', input);
      input.insertAdjacentElement('afterend', saveButton); 
      saveButton.insertAdjacentElement('afterend', cancelButton);
      input.focus();
      input.select(); 
    }

    // replyPreviewUser, replyPreviewText, replyPreviewDiv, cancelReplyBtn Ğ²Ğ¶Ğµ Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑˆĞµĞ½Ñ– Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾
    // msgInput Ñ‚Ğ°ĞºĞ¾Ğ¶ Ğ¾Ğ³Ğ¾Ğ»Ğ¾ÑˆĞµĞ½Ğ¾ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾

    function startReply(messageId, user, text) {
      currentReplyInfo = {
        messageId: messageId,
        user: user,
        text: text.length > 50 ? text.substring(0, 47) + "..." : text
      };

      replyPreviewUser.textContent = user;
      // Ğ¡Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ Ğ²Ğ¸Ğ´Ğ°Ğ»ÑÑ”Ğ¼Ğ¾ Ğ±ÑƒĞ´ÑŒ-ÑĞºÑ– Ğ¿Ğ¾Ğ¿ĞµÑ€ĞµĞ´Ğ½Ñ– ĞºĞ»Ğ°ÑĞ¸ ĞºĞ¾Ğ»ÑŒĞ¾Ñ€Ñ–Ğ²
      replyPreviewUser.classList.remove('reply-user-baby-color', 'reply-user-cloud-color');

      // Ğ—Ğ°ÑÑ‚Ğ¾ÑĞ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ½Ğ¾Ğ²Ğ¸Ğ¹ ĞºĞ»Ğ°Ñ ĞºĞ¾Ğ»ÑŒĞ¾Ñ€Ñƒ Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ Ğ²Ñ–Ğ´ ĞºĞ¾Ñ€Ğ¸ÑÑ‚ÑƒĞ²Ğ°Ñ‡Ğ°
      if (user === "Baby ğŸ˜") {
        replyPreviewUser.classList.add('reply-user-baby-color');
      } else if (user === "Pink Cloud â˜ï¸") {
        replyPreviewUser.classList.add('reply-user-cloud-color');
      }
      replyPreviewText.textContent = currentReplyInfo.text;
      replyPreviewDiv.style.display = 'flex';
      
      msgInput.focus(); 
    }

    function cancelReply() {
      currentReplyInfo = null;
      replyPreviewDiv.style.display = 'none';
    }

    if (cancelReplyBtn) {
      cancelReplyBtn.addEventListener('click', cancelReply);
    }
  </script>

</body>
</html>
