<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paradise</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
</head>
<body>

  <!-- –ï–∫—Ä–∞–Ω –≤—Ö–æ–¥—É -->
  <div class="login-screen" id="loginScreen">
    <h2>–í—Ö—ñ–¥ —É –ø–∞—Ä–∞–¥–∞–π–∑</h2>
    <input type="password" id="passwordInput" placeholder="–í–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å" />
    <div id="nicknameSelection" style="display: none;">
      <p>–í–∏–±–µ—Ä–∏ —Å–≤—ñ–π –Ω—ñ–∫–Ω–µ–π–º –º–∞–Ω—é–Ω—è –º–æ—è:</p>
      <button onclick="chooseNickname('Baby üòé')">Baby üòé</button>
      <button onclick="chooseNickname('Pink Cloud ‚òÅÔ∏è')">Pink Cloud ‚òÅÔ∏è</button>
    </div>
    <button id="loginButton" onclick="checkPassword()">–£–≤—ñ–π—Ç–∏</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- –ß–∞—Ç -->
  <div class="chat-container" id="chatContainer" style="display: none;">
    <h1>üå∏ ‚ù§ Rakhiv Paradise ‚ù§ üå∏</h1>
    <button id="openGalleryBtn" class="gallery-toggle-btn">üñºÔ∏è</button>
    <div id="chat" class="chat-box"></div>
    <!-- –ù–æ–≤–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –Ω–∞–±–æ—Ä—É —Ç–µ–∫—Å—Ç—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —á–∞—Ç—É -->
    <div id="chatTypingIndicator" class="typing-message-in-chat" style="visibility: hidden;"></div>
    <div class="media-controls-area">
      <!-- –ü—Ä–∏–ø—É—Å–∫–∞—î–º–æ, —â–æ —Ç—É—Ç –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≤–∏–±–æ—Ä—É –º—É–∑–∏–∫–∏, —è–∫—â–æ –≤–æ–Ω–∏ —î -->
      <div class="items">
        <!-- –ü—Ä–∏–∫–ª–∞–¥ –∫–Ω–æ–ø–∫–∏ –º—É–∑–∏–∫–∏, –¥–æ–¥–∞–π—Ç–µ —Å–≤–æ—ó, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ -->
        <!-- <button class="item-btn" onclick="playMusic('audio/your-song.mp3', this)">üéµ –ù–∞–∑–≤–∞ –ü—ñ—Å–Ω—ñ</button> -->
        <button class="item-btn" data-audiosrc="audio/Autumn-love.m4a" onclick="playMusic('audio/Autumn-love.m4a', this)">üçÇ–õ—é–±–æ–≤ —è–∫ –æ—Å—ñ–Ω—åüçÇ</button>
        <button class="item-btn" data-audiosrc="audio/Bounty.mp3" onclick="playMusic('audio/Bounty.mp3', this)">üíñBountyüíñ</button>
        <button class="item-btn" data-audiosrc="audio/Drevo.mp3" onclick="playMusic('audio/Drevo.mp3', this)">üå†–°–º–∞—Ä–∞–≥–¥–æ–≤–µ –Ω–µ–±–æüå†</button>
        <button class="item-btn" data-audiosrc="audio/MBreeze.mp3" onclick="playMusic('audio/MBreeze.mp3', this)">ü§ó–ö–æ–∂–µ–Ω –¥–µ–Ω—åü§ó</button>
        <button class="item-btn" data-audiosrc="audio/SoulScream.mp3" onclick="playMusic('audio/SoulScream.mp3', this)">ü•∞–ö—Ä–∏–∫ –≤ –ø—É—Å—Ç–æ—Ç—Éü•∞</button>
        <button class="item-btn" data-audiosrc="audio/WhenYouSmile.mp3" onclick="playMusic('audio/WhenYouSmile.mp3', this)">üòç–ö–æ–ª–∏ —Ç–∏ –ø–æ—Å–º—ñ—Ö–∞—î—à—Å—èüòç</button>
        <button class="item-btn" data-audiosrc="audio/song7.mp3" onclick="playMusic('audio/song7.mp3', this)">üéµ –ü—ñ—Å–Ω—è 7</button> 
      </div>
      <div class="volume-control">
        <button id="volumeToggleButton" class="item-btn">üîä</button>
        <input type="range" id="volumeSlider" class="volume-slider" min="0" max="1" step="0.01" value="0.5" style="display: none;">
      </div>
    </div>
    <!-- –ë–ª–æ–∫ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ - –ü–ï–†–ï–ú–Ü–©–ï–ù–û –°–Æ–î–ò -->
    <div id="replyPreview" class="reply-preview" style="display: none;">
      <div class="reply-preview-content"><strong id="replyPreviewUser"></strong>: <span id="replyPreviewText"></span></div>
      <button id="cancelReplyBtn" class="cancel-reply-btn">&times;</button>
    </div>
    <div class="input-controls">
      <textarea class="chat-input" id="msgInput" placeholder="–ü—ñ—à—ñ —É–∂–µ —à–æ—Å—å" rows="1"></textarea>
      <button id="emojiToggleBtn" class="emoji-toggle-btn">üòä</button>
      <input type="file" id="imageInput" accept="image/*" style="display: none;">
      <button id="attachImageBtn" class="attach-btn">üìé</button>
      <button class="chat-button">üí¨</button>
      <div id="emojiPanel" class="emoji-panel" style="display: none;">
        <!-- –ï–º–æ–¥–∑—ñ –±—É–¥—É—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ —Å—é–¥–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é JavaScript -->
      </div>
    </div>
    <div class="status-messages-container">
      <div id="users-online" class="users-online"></div>      
      <div id="imageUploadIndicator" class="upload-indicator" style="display: none;">–í—ñ–¥–ø—Ä–∞–≤–∫–∞ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è... üñºÔ∏è</div>
    </div>
  </div>

  <!-- –ë–ª–æ–∫ –¥–ª—è –≥—Ä–∏ –ö–∞–º—ñ–Ω—å, –ù–æ–∂–∏—Ü—ñ, –ü–∞–ø—ñ—Ä -->
    <div id="rpsGameArea" class="rps-game-area" style="display: none; border: 1px solid #ccc; padding: 10px; margin-top: 15px; border-radius: 8px; background-color: #f9f9f9; text-align: center;">
      <h3 style="margin-top: 0;">–ö–∞–º—ñ–Ω—å, –ù–æ–∂–∏—Ü—ñ, –ü–∞–ø—ñ—Ä</h3>
      <div id="rpsStatus" style="min-height: 20px; font-weight: bold; margin-bottom: 10px;"></div>
      <div id="rpsScore" style="margin-bottom: 10px;">–†–∞—Ö—É–Ω–æ–∫: –¢–∏ 0 - –°—É–ø–µ—Ä–Ω–∏–∫ 0</div>
      <div id="rpsPlayerMoves" style="display: flex; justify-content: space-around; margin-bottom: 15px; min-height: 30px;">
        <div id="rpsYourMove" style="font-size: 1.2em;">–¢–≤—ñ–π —Ö—ñ–¥: <span id="yourChoiceDisplay"></span></div>
        <div id="rpsOpponentMove" style="font-size: 1.2em;">–•—ñ–¥ —Å—É–ø–µ—Ä–Ω–∏–∫–∞: <span id="opponentChoiceDisplay"></span></div>
      </div>
      <div id="rpsChoices" style="display: none; margin-bottom: 10px;">
        <button class="rps-btn" data-move="rock" style="font-size: 1.5em; margin: 5px; padding: 10px; cursor: pointer;">‚úä</button>
        <button class="rps-btn" data-move="paper" style="font-size: 1.5em; margin: 5px; padding: 10px; cursor: pointer;">‚úã</button>
        <button class="rps-btn" data-move="scissors" style="font-size: 1.5em; margin: 5px; padding: 10px; cursor: pointer;">‚úåÔ∏è</button>
      </div>
      <button id="proposeRpsGameBtn" class="item-btn" style="margin-right: 10px;">–ì—Ä–∞—Ç–∏ –≤ –ö–ù–ü üé≤</button>
      <button id="quitRpsGameBtn" class="item-btn" style="display: none;">–ü–æ–∫–∏–Ω—É—Ç–∏ –≥—Ä—É üè≥Ô∏è</button>
    </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –∑–æ–±—Ä–∞–∂–µ–Ω—å –∑ —á–∞—Ç—É -->
  <div id="chatImageDisplayModal" class="gallery-modal" style="display: none;">
    <button id="closeChatImageDisplayModalBtn" class="gallery-close-btn">&times;</button>
    <div class="gallery-content">
      <img id="chatDisplayImage" src="" alt="–ó–±—ñ–ª—å—à–µ–Ω–µ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ —á–∞—Ç—É" style="max-width: 90vw; max-height: 90vh; object-fit: contain;" />
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≥–∞–ª–µ—Ä–µ—ó -->
  <div id="imageGalleryModal" class="gallery-modal" style="display: none;">
    <button id="closeGalleryBtn" class="gallery-close-btn">&times;</button>
    <div class="gallery-content">
      <button id="prevImageBtn" class="gallery-nav-btn prev-btn" aria-label="Previous image">&lt;</button>
      <div class="gallery-images-container" id="galleryImagesContainer">
        <!-- –ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –±—É–¥—É—Ç—å –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ —Å—é–¥–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é JavaScript -->
      </div>
      <button id="nextImageBtn" class="gallery-nav-btn next-btn" aria-label="Next image">&gt;</button>
    </div>
  </div>

  <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è -->
  <div id="customConfirmModal" class="custom-modal" style="display: none;">
    <div class="custom-modal-content">
      <span id="customConfirmModalCloseBtn" class="custom-modal-close-btn">&times;</span>
      <p id="customConfirmModalText">–£–¥–∞–ª—ñ—Ç—å üò±?</p>
      <div class="custom-modal-buttons">
        <button id="customConfirmOkBtn" class="custom-modal-btn custom-modal-ok-btn">–¢–∞–∫</button>
        <button id="customConfirmCancelBtn" class="custom-modal-btn custom-modal-cancel-btn">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
      </div>
    </div>
  </div>
  <script>
    let selectedNickname = null;
    let socket = null;
    // Player and related variables
    const musicPlayer = new Audio();
    let currentPlayingButton = null;
    let currentReplyInfo = null; // –î–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –Ω–∞ —è–∫–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î–º–æ
    let currentGlobalAudioSrc = null; // –ó–±–µ—Ä—ñ–≥–∞—î src –ø–æ—Ç–æ—á–Ω–æ—ó –≥–ª–æ–±–∞–ª—å–Ω–æ—ó –ø—ñ—Å–Ω—ñ
    let messageIdToDeleteGlobally = null; // –î–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è ID –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —è–∫–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î—Ç—å—Å—è –Ω–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è

    // DOM Element References - Initialized once the script loads
    // Login Screen
    const loginScreen = document.getElementById('loginScreen');
    const passwordInput = document.getElementById('passwordInput');
    const nicknameSelection = document.getElementById('nicknameSelection');
    const loginButton = document.getElementById('loginButton'); 
    const loginError = document.getElementById('loginError');
    const chatContainer = document.getElementById('chatContainer');

    // Chat Area
    const chat = document.getElementById('chat');
    const chatTypingIndicator = document.getElementById('chatTypingIndicator');
    const msgInput = document.getElementById('msgInput');
    const emojiToggleBtn = document.getElementById('emojiToggleBtn');
    const imageInput = document.getElementById('imageInput');
    const attachImageBtn = document.getElementById('attachImageBtn');
    const emojiPanel = document.getElementById('emojiPanel');
    const usersOnlineDiv = document.getElementById('users-online');
    const imageUploadIndicator = document.getElementById('imageUploadIndicator');

    // Reply Functionality
    const replyPreviewDiv = document.getElementById('replyPreview');
    const replyPreviewUser = document.getElementById('replyPreviewUser');
    const replyPreviewText = document.getElementById('replyPreviewText');
    const cancelReplyBtn = document.getElementById('cancelReplyBtn');

    // Modals and Gallery
    const openGalleryBtn = document.getElementById('openGalleryBtn');
    const closeGalleryBtn = document.getElementById('closeGalleryBtn');
    const imageGalleryModal = document.getElementById('imageGalleryModal');
    const galleryImagesContainer = document.getElementById('galleryImagesContainer');
    const prevImageBtn = document.getElementById('prevImageBtn');
    const nextImageBtn = document.getElementById('nextImageBtn');
    const chatImageDisplayModal = document.getElementById('chatImageDisplayModal');
    const chatDisplayImage = document.getElementById('chatDisplayImage'); 
    const closeChatImageDisplayModalBtn = document.getElementById('closeChatImageDisplayModalBtn');

    // Media Controls
    const volumeToggleButton = document.getElementById('volumeToggleButton');
    const volumeSlider = document.getElementById('volumeSlider');

    // Custom Confirm Modal Elements
    const customConfirmModal = document.getElementById('customConfirmModal');
    const customConfirmModalText = document.getElementById('customConfirmModalText');
    const customConfirmOkBtn = document.getElementById('customConfirmOkBtn');
    const customConfirmCancelBtn = document.getElementById('customConfirmCancelBtn');
    const customConfirmModalCloseBtn = document.getElementById('customConfirmModalCloseBtn');

    // Global Constants
    const avatars = {
     "Baby üòé": "üòé",
     "Pink Cloud ‚òÅÔ∏è": "‚òÅÔ∏è"
    };

    const userColors = {
     "Baby üòé": "message-baby",
     "Pink Cloud ‚òÅÔ∏è": "message-cloud"
    };

    function checkPassword() {
      const passwordValue = passwordInput.value; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É
      if (passwordValue === "26060512") {
        nicknameSelection.style.display = "block"; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É
        passwordInput.style.display = "none"; 
        loginButton.style.display = "none";   // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É
        loginError.textContent = ""; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É
      } else {
        loginError.textContent = "–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∏–π –ø–∞—Ä–æ–ª—å."; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É
      }
    }

    function chooseNickname(nick) {
      selectedNickname = nick;
      loginScreen.style.display = "none"; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É
      chatContainer.style.display = "flex"; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É
      startChat();
    }

    function startChat() {
      socket = io("https://cloud-baby.onrender.com", {
        transports: ["websocket"]
      });

      // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –∂–∏—Ç—Ç—î–≤–æ–≥–æ —Ü–∏–∫–ª—É —Å–æ–∫–µ—Ç–∞
      socket.on('connect', () => {
        console.log('–ö–ª—ñ—î–Ω—Ç: Socket.IO –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!');
        // –ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è, —Ä–µ—î—Å—Ç—Ä—É—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        socket.emit("register", selectedNickname); 
        // –ó–∞–ø–∏—Ç —ñ—Å—Ç–æ—Ä—ñ—ó —á–∞—Ç—É
        socket.emit("get_history");
        // –°–µ—Ä–≤–µ—Ä —ñ —Ç–∞–∫ –Ω–∞–¥—Å–∏–ª–∞—î —Å—Ç–∞–Ω —Ç–∞–º–∞–≥–æ—á—ñ –ø—Ä–∏ 'connect' —Ç–∞ 'register',
        // —Ç–æ–º—É —è–≤–Ω–∏–π –∑–∞–ø–∏—Ç —Ç—É—Ç –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ –ø–æ—Ç—Ä—ñ–±–µ–Ω, –∞–ª–µ –Ω–µ –∑–∞–≤–∞–¥–∏—Ç—å –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏, —è–∫—â–æ —î —Ç–∞–∫–∞ –ø–æ–¥—ñ—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.
        // socket.emit('get_tamagotchi_state'); // –Ø–∫—â–æ —Ç–∞–∫–∞ –ø–æ–¥—ñ—è —ñ—Å–Ω—É—î
      });

      socket.on('disconnect', (reason) => {
        console.warn('–ö–ª—ñ—î–Ω—Ç: Socket.IO –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ. –ü—Ä–∏—á–∏–Ω–∞:', reason);
        // –ú–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –ª–æ–≥—ñ–∫—É –¥–ª—è —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∞–±–æ —Å–ø—Ä–æ–±–∏ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
        // if (reason === 'io server disconnect') {
        //   socket.connect(); // –°–ø—Ä–æ–±–∞ –ø–µ—Ä–µ–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è, —è–∫—â–æ —Å–µ—Ä–≤–µ—Ä —Ä–æ–∑—ñ—Ä–≤–∞–≤ –∑'—î–¥–Ω–∞–Ω–Ω—è
        // }
      });

      socket.on('connect_error', (err) => {
        console.error('–ö–ª—ñ—î–Ω—Ç: –ü–æ–º–∏–ª–∫–∞ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Socket.IO:', err.message, err);
      });


      socket.on("message", (data) => { // –û–±—Ä–æ–±–Ω–∏–∫ –Ω–æ–≤–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
        const messageElement = renderMessage(data); 
        chat.appendChild(messageElement);
        scrollToBottom();
      });

      socket.on('update_global_music_state', (data) => {
        if (currentPlayingButton) {
          currentPlayingButton.classList.remove('playing');
          currentPlayingButton = null;
        }

        if (data.status === 'playing') {
          currentGlobalAudioSrc = data.audiosrc;
          musicPlayer.src = data.audiosrc;
          musicPlayer.play().catch(e => console.error("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥—Ç–≤–æ—Ä–µ–Ω–Ω—è –≥–ª–æ–±–∞–ª—å–Ω–æ—ó –º—É–∑–∏–∫–∏:", e));
          
          const buttonToPlay = findMusicButtonBySrc(data.audiosrc);
          if (buttonToPlay) {
            buttonToPlay.classList.add('playing');
            currentPlayingButton = buttonToPlay;
          }
        } else if (data.status === 'stopped') {
          musicPlayer.pause();
          // musicPlayer.src = ""; // –ú–æ–∂–Ω–∞ —Ä–æ–∑–∫–æ–º–µ–Ω—Ç—É–≤–∞—Ç–∏, —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–≤–Ω—ñ—Å—Ç—é —Å–∫–∏–¥–∞—Ç–∏ src
          currentGlobalAudioSrc = null;
          // currentPlayingButton –≤–∂–µ —Å–∫–∏–Ω—É—Ç–æ –≤–∏—â–µ
        }
      });

      // –ó–∞–ø–∏—Ç –ø–æ—Ç–æ—á–Ω–æ–≥–æ —Å—Ç–∞–Ω—É –º—É–∑–∏–∫–∏ –ø—Ä–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ (—Å–µ—Ä–≤–µ—Ä –º–∞—î —Ü–µ –æ–±—Ä–æ–±–ª—è—Ç–∏)
      // socket.emit('get_current_music_state'); 
      // –ü—Ä–∏–º—ñ—Ç–∫–∞: –°–µ—Ä–≤–µ—Ä –º–∞—î –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ —Å—Ç–∞–Ω –ø—Ä–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ –Ω–æ–≤–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞.
      // –¶–µ–π —è–≤–Ω–∏–π –∑–∞–ø–∏—Ç –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ–ø–æ—Ç—Ä—ñ–±–Ω–∏–º, —è–∫—â–æ —Å–µ—Ä–≤–µ—Ä –≤–∂–µ —Ç–∞–∫ —Ä–æ–±–∏—Ç—å.


      socket.on('message_edited', (data) => {
        const messageDiv = document.querySelector(`.message[data-message-id="${data.messageId}"]`);
        if (messageDiv) {
          const textContentElement = messageDiv.querySelector('.message-text-content');
          if (textContentElement) {
            textContentElement.textContent = data.newText; 

            let editedMark = messageDiv.querySelector('.message-edited-indicator'); // –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–∑–≤—É –∫–ª–∞—Å—É
            if (!editedMark) {
              editedMark = document.createElement('span');
              editedMark.classList.add('message-edited-indicator'); // –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞–∑–≤—É –∫–ª–∞—Å—É
              editedMark.textContent = '(–≤—ñ–¥—Ä–µ–¥–∞–≥–æ–≤–∞–Ω–æ)';
              textContentElement.insertAdjacentElement('afterend', editedMark);
            }
          }
        }
      });

      socket.on('message_deleted', (data) => {
        const messageDiv = document.querySelector(`.message[data-message-id="${data.messageId}"]`);
        if (messageDiv) {
          messageDiv.remove();
        }
      });

      socket.on("chat_history", (messages) => { 
        messages.forEach(data => {
          const messageElement = renderMessage(data); 
          chat.appendChild(messageElement);
        });
        scrollToBottom();
      });

      socket.on("users_online", (users) => {
        // usersOnlineDiv –≤–∂–µ –æ–≥–æ–ª–æ—à–µ–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–æ
        let displayString = "";

        const hasBaby = users.includes("Baby üòé");
        const hasCloud = users.includes("Pink Cloud ‚òÅÔ∏è");

        if (hasBaby && hasCloud) {
          displayString = `
            <div class="finger-lightning-container">
              <div class="finger left">üëâ</div>
              <div class="lightning"></div>
              <div class="finger right">üëà</div>
            </div>
          `;
        } else if (hasBaby) {
          displayString = `<div class="finger-lightning-container"><div>üëâ</div></div>`;
        } else if (hasCloud) {
          displayString = `<div class="finger-lightning-container"><div>üëà</div></div>`;
        }
        
        usersOnlineDiv.innerHTML = displayString || "–ù—ñ–∫–æ–≥–æ –Ω–µ–º–∞—î –≤ –º–µ—Ä–µ–∂—ñ";
      });

      socket.on("typing", (data) => {
        // chatTypingIndicator –≤–∂–µ –æ–≥–æ–ª–æ—à–µ–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–æ
        if (data.typing) {          
          const userAvatar = avatars[data.user] || "üë§"; 
          chatTypingIndicator.textContent = `${userAvatar} ${data.user} —à–æ—Å—å —Ç–∞–º —Ü—ñ–∫–∞–≤–µ–Ω—å–∫–µ –ø–∏—à–µ...–ª—é–±–ª—è—á–∏ —Ç–µ–±–µ –¥—É–∂–µ —Å–∏–ª—å–Ω–æ!`;
          chatTypingIndicator.style.visibility = 'visible';
          scrollToBottom(); 
        } else {
          chatTypingIndicator.style.visibility = 'hidden';
        }
      });


      // msgInput –≤–∂–µ –æ–≥–æ–ª–æ—à–µ–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–æ
      let typingTimeout;

      msgInput.addEventListener("input", () => {
        socket.emit("typing", true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.emit("typing", false);
        }, 2000);
      });

      msgInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      document.querySelector(".chat-button").addEventListener("click", () => sendMessage());
      
      // attachImageBtn —Ç–∞ imageInput –≤–∂–µ –æ–≥–æ–ª–æ—à–µ–Ω—ñ –≥–ª–æ–±–∞–ª—å–Ω–æ

      attachImageBtn.addEventListener('click', () => {
        imageInput.click(); 
      });

      imageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
          // imageUploadIndicator –≤–∂–µ –æ–≥–æ–ª–æ—à–µ–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–æ
          imageUploadIndicator.style.display = 'block'; 

          const reader = new FileReader();
          reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
              const canvas = document.createElement('canvas');
              const MAX_WIDTH = 800; 
              const MAX_HEIGHT = 600; 
              let width = img.width;
              let height = img.height;

              if (width > height) {
                if (width > MAX_WIDTH) {
                  height *= MAX_WIDTH / width;
                  width = MAX_WIDTH;
                }
              } else {
                if (height > MAX_HEIGHT) {
                  width *= MAX_HEIGHT / height;
                  height = MAX_HEIGHT;
                }
              }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              const compressedImageDataUrl = canvas.toDataURL('image/jpeg', 0.9); 

              socket.emit("message", { type: 'image', image: compressedImageDataUrl }, () => {
                imageUploadIndicator.style.display = 'none';
              });
            }
            img.src = e.target.result; 
          }
          reader.readAsDataURL(file);
          imageInput.value = ''; 
        } else if (file) { 
            alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è (JPEG, PNG, GIF).");
            imageUploadIndicator.style.display = 'none'; 
        }
      });
    }

    function renderMessage(data) {
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message");
      messageDiv.dataset.messageId = data.messageId; 
      const colorClass = userColors[data.user];
      if (colorClass) messageDiv.classList.add(colorClass);

      if (data.replyTo) {
        const replyQuoteDiv = document.createElement('div');
        replyQuoteDiv.classList.add('message-reply-quote');
        
        const originalSender = document.createElement('strong');
        originalSender.textContent = data.replyTo.user;
        // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å –¥–ª—è –∫–æ–ª—å–æ—Ä—É —ñ–º–µ–Ω—ñ –≤ —Ü–∏—Ç–∞—Ç—ñ
        if (data.replyTo.user === "Baby üòé") {
            originalSender.classList.add('reply-quote-user-baby-color');
        } else if (data.replyTo.user === "Pink Cloud ‚òÅÔ∏è") {
            originalSender.classList.add('reply-quote-user-cloud-color');
        }
        
        const originalText = document.createElement('span');
        originalText.textContent = `: ${data.replyTo.text}`; 

        replyQuoteDiv.appendChild(originalSender);
        replyQuoteDiv.appendChild(originalText);
        
        replyQuoteDiv.onclick = () => scrollToMessage(data.replyTo.messageId);
        messageDiv.appendChild(replyQuoteDiv); 
      }

      if (data.type === 'image' && data.image) {
        const img = document.createElement('img');
        img.src = data.image;
        img.alt = "–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤—ñ–¥ " + data.user;
        img.classList.add('chat-image-thumbnail');
        img.onclick = () => displayChatImageFull(data.image);
        const senderInfo = document.createElement('span');
        senderInfo.textContent = `${avatars[data.user] || "üë§"} ${data.user}: `;
        senderInfo.classList.add('message-sender', 'message-sender-image'); 
        messageDiv.appendChild(senderInfo);
        messageDiv.appendChild(img);
      } else {
        const senderInfo = document.createElement('span');
        senderInfo.textContent = `${avatars[data.user] || "üë§"} ${data.user}: `;
        senderInfo.classList.add('message-sender');

        const textContent = document.createElement('span');
        textContent.classList.add('message-text-content'); 
        textContent.textContent = data.text;

        messageDiv.appendChild(senderInfo);
        messageDiv.appendChild(textContent);
      }

      const actionsDiv = document.createElement("div");
      actionsDiv.classList.add("message-actions");

      if (data.user === "Baby üòé") { 
        actionsDiv.classList.add("actions-left");
      } else if (data.user === "Pink Cloud ‚òÅÔ∏è") { 
        actionsDiv.classList.add("actions-right");
      }

      const replyButton = document.createElement("button");
      replyButton.classList.add("action-btn", "reply-btn", "tooltip");
      replyButton.innerHTML = "&#8617;"; 
      replyButton.title = "–í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏";
      replyButton.onclick = () => startReply(data.messageId, data.user, data.type === 'text' ? data.text : "–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è");

      if (data.user === selectedNickname) {
        const editButton = document.createElement("button");
        editButton.classList.add("action-btn", "edit-btn", "tooltip");
        editButton.innerHTML = "&#9998;"; 
        editButton.title = "–†–µ–¥–∞–≥—É–≤–∞—Ç–∏";
        editButton.onclick = () => startEditMessage(data.messageId, messageDiv, data.type === 'text' ? data.text : null);
        if (data.type !== 'text') editButton.style.display = 'none'; 

        const deleteButton = document.createElement("button");
        deleteButton.classList.add("action-btn", "delete-btn", "tooltip");
        deleteButton.innerHTML = "&#128465;"; 
        deleteButton.title = "–í–∏–¥–∞–ª–∏—Ç–∏";
        deleteButton.onclick = () => deleteMessage(data.messageId);

        actionsDiv.appendChild(deleteButton); 
        actionsDiv.appendChild(editButton);
      }
      actionsDiv.appendChild(replyButton); 
      messageDiv.appendChild(actionsDiv);

      return messageDiv; 
    }

    function scrollToMessage(messageId) {
      const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
      if (messageElement) {
        messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        messageElement.classList.add('highlight-message'); 
        setTimeout(() => messageElement.classList.remove('highlight-message'), 1500);
      }
    }
    function sendMessage() {
      // msgInput –≤–∂–µ –æ–≥–æ–ª–æ—à–µ–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–æ
      const msg = msgInput.value.trim();
      // –õ–û–ì 1: –ß–∏ –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è —Ü—è —Ñ—É–Ω–∫—Ü—ñ—è? –Ø–∫–∏–π —Å—Ç–∞–Ω —Å–æ–∫–µ—Ç–∞ —ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è?
      console.log("–ö–ª—ñ—î–Ω—Ç: sendMessage() –≤–∏–∫–ª–∏–∫–∞–Ω–æ. –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:", msg, "Socket –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ:", socket && socket.connected);
      if (socket && socket.connected && msg) { // –î–æ–¥–∞–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É socket.connected
        const messagePayload = { type: 'text', text: msg };
        if (currentReplyInfo) {
          messagePayload.replyTo = currentReplyInfo;
        }
        // –õ–û–ì 2: –ß–∏ –∑–±–∏—Ä–∞—î–º–æ—Å—è –º–∏ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –¥–∞–Ω—ñ?
        console.log("–ö–ª—ñ—î–Ω—Ç: –ù–∞–º–∞–≥–∞—é—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ 'message':", messagePayload);
        socket.emit("message", messagePayload);
        cancelReply(); 
        msgInput.value = "";
      } else {
        // –õ–û–ì 3: –ß–æ–º—É –Ω–µ –Ω–∞–¥—Å–∏–ª–∞—î–º–æ?
        console.log("–ö–ª—ñ—î–Ω—Ç: –ù–µ –Ω–∞–¥—Å–∏–ª–∞—é 'message'. Socket –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ:", socket && socket.connected, "–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ—Ä–æ–∂–Ω—î:", !msg);
      }
    }

    function scrollToBottom() {
      // chat (chatBox) –≤–∂–µ –æ–≥–æ–ª–æ—à–µ–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–æ
      chat.scrollTop = chat.scrollHeight;
    }

    function playMusic(audiosrc, buttonElement) {
      if (!socket) return;

      if (currentGlobalAudioSrc === audiosrc && !musicPlayer.paused) {
        // –Ø–∫—â–æ —Ü—è –ø—ñ—Å–Ω—è –≤–∂–µ –≥—Ä–∞—î –≥–ª–æ–±–∞–ª—å–Ω–æ, –∑—É–ø–∏–Ω—è—î–º–æ —ó—ó
        socket.emit('control_global_music', { action: 'stop' });
      } else {
        // –Ü–Ω–∞–∫—à–µ, –ø–æ—á–∏–Ω–∞—î–º–æ –≥—Ä–∞—Ç–∏ —Ü—é –ø—ñ—Å–Ω—é –≥–ª–æ–±–∞–ª—å–Ω–æ
        socket.emit('control_global_music', { action: 'play', audiosrc: audiosrc });
      }
    }

    musicPlayer.onended = function() {
      // –ö–æ–ª–∏ –ø—ñ—Å–Ω—è –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è, –ø–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ —Å–µ—Ä–≤–µ—Ä,
      // —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —Ü–µ –±—É–ª–∞ –≥–ª–æ–±–∞–ª—å–Ω–æ –≤—ñ–¥—Ç–≤–æ—Ä—é–≤–∞–Ω–∞ –ø—ñ—Å–Ω—è.
      if (musicPlayer.src && musicPlayer.src === currentGlobalAudioSrc) {
        if (socket) {
          // –ü–µ—Ä–µ–¥–∞—î–º–æ audiosrc, —â–æ–± —Å–µ—Ä–≤–µ—Ä –º—ñ–≥ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ —Ü–µ –¥—ñ–π—Å–Ω–æ –ø–æ—Ç–æ—á–Ω–∏–π —Ç—Ä–µ–∫
          socket.emit('control_global_music', { action: 'stop_after_ended', audiosrc: musicPlayer.src });
        }
      }
      // –õ–æ–∫–∞–ª—å–Ω–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è UI (—Å–∫–∏–¥–∞–Ω–Ω—è –∫–Ω–æ–ø–∫–∏ 'playing') –≤—ñ–¥–±—É–¥–µ—Ç—å—Å—è,
      // –∫–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–∞–¥—ñ—à–ª–µ 'update_global_music_state' –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º 'stopped'.
    };
    
    // volumeToggleButton —Ç–∞ volumeSlider –≤–∂–µ –æ–≥–æ–ª–æ—à–µ–Ω—ñ –≥–ª–æ–±–∞–ª—å–Ω–æ

    function updateVolumeIcon(volume) {
      if (volume === 0) {
        volumeToggleButton.textContent = 'üîá';
      } else if (volume <= 0.33) {
        volumeToggleButton.textContent = 'üîà';
      } else if (volume <= 0.66) {
        volumeToggleButton.textContent = 'üîâ';
      } else {
        volumeToggleButton.textContent = 'üîä';
      }
    }

    let initialVolume = parseFloat(localStorage.getItem('playerVolume'));
    if (isNaN(initialVolume) || initialVolume < 0 || initialVolume > 1) {
      initialVolume = 0.5; 
    }
    musicPlayer.volume = initialVolume;
    volumeSlider.value = initialVolume;
    updateVolumeIcon(initialVolume);

    volumeToggleButton.addEventListener('click', () => {
      if (volumeSlider.style.display === 'none') {
        volumeSlider.style.display = 'inline-block'; 
      } else {
        volumeSlider.style.display = 'none';
      }
    });

    volumeSlider.addEventListener('input', function() {
      musicPlayer.volume = this.value;
      updateVolumeIcon(parseFloat(this.value));
      localStorage.setItem('playerVolume', this.value);
    });

    // openGalleryBtn, closeGalleryBtn, imageGalleryModal, galleryImagesContainer,
    // prevImageBtn, nextImageBtn, chatImageDisplayModal (—è–∫ chatDisplayModal), 
    // emojiToggleBtn, emojiPanel, chatDisplayImage (—è–∫ chatDisplayImg), 
    // closeChatImageDisplayModalBtn (—è–∫ closeChatImageDisplayBtn) –≤–∂–µ –æ–≥–æ–ª–æ—à–µ–Ω—ñ –≥–ª–æ–±–∞–ª—å–Ω–æ

    function displayChatImageFull(imageSrc) {
      chatDisplayImage.src = imageSrc; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É
      chatImageDisplayModal.style.display = 'flex'; // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É
      chatImageDisplayModal.classList.remove('hide');
      chatImageDisplayModal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    if (closeChatImageDisplayModalBtn) { // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É
      closeChatImageDisplayModalBtn.addEventListener('click', () => {
        chatImageDisplayModal.classList.remove('show'); // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—É –∑–º—ñ–Ω–Ω—É
        chatImageDisplayModal.classList.add('hide');
        setTimeout(() => {
          if (chatImageDisplayModal.classList.contains('hide')) {
            chatImageDisplayModal.style.display = 'none';
          }
          document.body.style.overflow = 'auto';
        }, 400); 
      });
    }

    const galleryImageSources = [
      'img/1.jpg', 'img/2.jpg', 'img/3.jpg', 'img/4.jpg', 'img/5.jpg',
      'img/6.jpg', 'img/7.jpg', 'img/8.jpg', 'img/9.jpg', 'img/10.jpg'
    ];
    let imagesInGalleryLoaded = false;

    function populateGallery() {
      if (imagesInGalleryLoaded) return;
      galleryImagesContainer.innerHTML = ''; 
      galleryImageSources.forEach(src => {
        const img = document.createElement('img');
        img.src = src;
        img.alt = "–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∑ –≥–∞–ª–µ—Ä–µ—ó";
        galleryImagesContainer.appendChild(img);
      });
      imagesInGalleryLoaded = true;
    }

    openGalleryBtn.addEventListener('click', () => {
      populateGallery();
      imageGalleryModal.style.display = 'flex'; 
      imageGalleryModal.classList.remove('hide'); 
      imageGalleryModal.classList.add('show');
      document.body.style.overflow = 'hidden'; 
    });

    closeGalleryBtn.addEventListener('click', () => {
      imageGalleryModal.classList.remove('show');
      imageGalleryModal.classList.add('hide');
      
      setTimeout(() => {
        if (imageGalleryModal.classList.contains('hide')) {
          imageGalleryModal.style.display = 'none'; 
        }
        document.body.style.overflow = 'auto'; 
      }, 400); 

    });

    prevImageBtn.addEventListener('click', () => {
      galleryImagesContainer.scrollBy({ left: -galleryImagesContainer.clientWidth, behavior: 'smooth' });
    });

    nextImageBtn.addEventListener('click', () => {
      galleryImagesContainer.scrollBy({ left: galleryImagesContainer.clientWidth, behavior: 'smooth' });
    });

    const emojis = ['üòÄ', 'üòÇ', 'üòä', 'üòç', 'ü§î', 'üò¢', 'üò†', 'üëç', 'üëé', '‚ù§Ô∏è', 'üñ§' , 'üíö', 'üíô' , 'üíõ' , 'üíú' , 'üß°' , 'ü§é' , 'ü§ç' , 'üéâ', '‚ú®', 'üå∏', '‚òÅÔ∏è', 'üòé', 'üçÇ', 'üíñ', 'üå†', 'ü§ó', 'üåå', 'üòò', 'üòú', 'üòá', 'ü•≥', 'üò≠', 'üôè', 'üëÄ', 'üëã', 'üíØ'];

    function populateEmojiPanel() {
      emojis.forEach(emoji => {
        const emojiSpan = document.createElement('span');
        emojiSpan.textContent = emoji;
        emojiSpan.setAttribute('role', 'button'); 
        emojiSpan.setAttribute('tabindex', '0');  
        emojiSpan.addEventListener('click', () => insertEmoji(emoji));
        emojiSpan.addEventListener('keydown', (e) => { 
          if (e.key === 'Enter' || e.key === ' ') {
            insertEmoji(emoji);
          }
        });
        emojiPanel.appendChild(emojiSpan);
      });
    }

    function insertEmoji(emoji) {
      // msgInput –≤–∂–µ –æ–≥–æ–ª–æ—à–µ–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–æ
      const start = msgInput.selectionStart;
      const end = msgInput.selectionEnd;
      const text = msgInput.value;
      msgInput.value = text.substring(0, start) + emoji + text.substring(end);
      msgInput.focus();
      msgInput.selectionStart = msgInput.selectionEnd = start + emoji.length;
    }

    emojiToggleBtn.addEventListener('click', (event) => {
      event.stopPropagation(); 
      emojiPanel.style.display = emojiPanel.style.display === 'none' ? 'grid' : 'none';
    });

    document.addEventListener('click', (event) => {
      if (emojiPanel.style.display === 'grid' && !emojiPanel.contains(event.target) && event.target !== emojiToggleBtn) {
        emojiPanel.style.display = 'none';
      }
    });
    populateEmojiPanel(); 

    function deleteMessage(messageId) {
      messageIdToDeleteGlobally = messageId;
      customConfirmModalText.textContent = "–£–¥–∞–ª—ñ—Ç—å üò±?";
      customConfirmModal.style.display = 'flex';
    }

    function hideCustomConfirm() {
      customConfirmModal.style.display = 'none';
      messageIdToDeleteGlobally = null;
    }

    if (customConfirmOkBtn) {
      customConfirmOkBtn.addEventListener('click', () => {
        if (socket) {
          socket.emit('delete_message', { messageId: messageIdToDeleteGlobally });
        }
        hideCustomConfirm();
      });
    }
    if (customConfirmCancelBtn) {
      customConfirmCancelBtn.addEventListener('click', hideCustomConfirm);
    }
    if (customConfirmModalCloseBtn) {
      customConfirmModalCloseBtn.addEventListener('click', hideCustomConfirm);
    }

    function startEditMessage(messageId, messageDiv, currentText) {
      if (!currentText) return; 

      if (messageDiv.querySelector('.edit-message-input')) {
        return;
      }

      const textContentElement = messageDiv.querySelector('.message-text-content');
      if (!textContentElement) {
        console.error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ .message-text-content –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≤:", messageDiv);
        return;
      }
      currentText = textContentElement.textContent;

      textContentElement.style.display = 'none';
      const actionsDiv = messageDiv.querySelector('.message-actions');
      if (actionsDiv) {
        actionsDiv.style.display = 'none';
      }
      
      const input = document.createElement('textarea');
      input.classList.add('edit-message-input');
      input.value = currentText; 
      input.rows = Math.max(1, Math.min(5, (currentText.match(/\n/g) || []).length + 1)); 
      input.onkeydown = (e) => { 
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          saveButton.click();
        } else if (e.key === 'Escape') {
          cancelButton.click();
        }
      };
      
      const saveButton = document.createElement('button');
      saveButton.textContent = '–ó–±–µ—Ä–µ–≥—Ç–∏';
      saveButton.classList.add('action-btn', 'save-edit-btn');
      saveButton.onclick = () => {
        const newText = input.value.trim();

        if (newText && newText !== currentText) {
          if (socket) {
            socket.emit('edit_message', { messageId, newText });
          }
        } 
        messageDiv.removeChild(saveButton);
        messageDiv.removeChild(cancelButton);
        messageDiv.removeChild(input);

        textContentElement.style.display = '';
        if (actionsDiv) actionsDiv.style.display = 'flex'; 
      };

      const cancelButton = document.createElement('button');
      cancelButton.textContent = '–°–∫–∞—Å—É–≤–∞—Ç–∏';
      cancelButton.classList.add('action-btn', 'cancel-edit-btn');
      cancelButton.onclick = () => {
        messageDiv.removeChild(saveButton);
        messageDiv.removeChild(cancelButton);
        messageDiv.removeChild(input);
        
        textContentElement.style.display = '';
        if (actionsDiv) actionsDiv.style.display = 'flex';
      };

      const senderElement = messageDiv.querySelector('.message-sender');
      (senderElement || messageDiv.firstChild).insertAdjacentElement('afterend', input);
      input.insertAdjacentElement('afterend', saveButton); 
      saveButton.insertAdjacentElement('afterend', cancelButton);
      input.focus();
      input.select(); 
    }

    // replyPreviewUser, replyPreviewText, replyPreviewDiv, cancelReplyBtn –≤–∂–µ –æ–≥–æ–ª–æ—à–µ–Ω—ñ –≥–ª–æ–±–∞–ª—å–Ω–æ
    // msgInput —Ç–∞–∫–æ–∂ –æ–≥–æ–ª–æ—à–µ–Ω–æ –≥–ª–æ–±–∞–ª—å–Ω–æ

    function startReply(messageId, user, text) {
      currentReplyInfo = {
        messageId: messageId,
        user: user,
        text: text.length > 50 ? text.substring(0, 47) + "..." : text
      };

      replyPreviewUser.textContent = user;
      // –°–ø–æ—á–∞—Ç–∫—É –≤–∏–¥–∞–ª—è—î–º–æ –±—É–¥—å-—è–∫—ñ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –∫–ª–∞—Å–∏ –∫–æ–ª—å–æ—Ä—ñ–≤
      replyPreviewUser.classList.remove('reply-user-baby-color', 'reply-user-cloud-color');

      // –ó–∞—Å—Ç–æ—Å–æ–≤—É—î–º–æ –Ω–æ–≤–∏–π –∫–ª–∞—Å –∫–æ–ª—å–æ—Ä—É –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
      if (user === "Baby üòé") {
        replyPreviewUser.classList.add('reply-user-baby-color');
      } else if (user === "Pink Cloud ‚òÅÔ∏è") {
        replyPreviewUser.classList.add('reply-user-cloud-color');
      }
      replyPreviewText.textContent = currentReplyInfo.text;
      replyPreviewDiv.style.display = 'flex';
      
      msgInput.focus(); 
    }

    function cancelReply() {
      currentReplyInfo = null;
      replyPreviewDiv.style.display = 'none';
    }

    if (cancelReplyBtn) {
      cancelReplyBtn.addEventListener('click', cancelReply);
    }

    // –î–æ–ø–æ–º—ñ–∂–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ—à—É–∫—É –∫–Ω–æ–ø–∫–∏ –º—É–∑–∏–∫–∏ –∑–∞ —ó—ó src
    function findMusicButtonBySrc(audiosrc) {
      // –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—è, —â–æ –≤–∏ –¥–æ–¥–∞–ª–∏ –∞—Ç—Ä–∏–±—É—Ç data-audiosrc –¥–æ HTML-–∫–Ω–æ–ø–æ–∫ –º—É–∑–∏–∫–∏
      return document.querySelector(`.media-controls-area .item-btn[data-audiosrc="${audiosrc}"]`);
    }

    // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –≤—ñ–∫–Ω–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º
    window.addEventListener('click', (event) => {
      if (event.target === customConfirmModal) {
        hideCustomConfirm();
      }
    });

    // --- –ü–æ—á–∞—Ç–æ–∫ –∫–æ–¥—É –¥–ª—è –≥—Ä–∏ –ö–∞–º—ñ–Ω—å, –ù–æ–∂–∏—Ü—ñ, –ü–∞–ø—ñ—Ä ---

// –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ –¥–ª—è –µ–ª–µ–º–µ–Ω—Ç—ñ–≤ –≥—Ä–∏ (–ø–µ—Ä–µ–∫–æ–Ω–∞–π—Å—è, —â–æ –≤–æ–Ω–∏ –Ω–µ –∫–æ–Ω—Ñ–ª—ñ–∫—Ç—É—é—Ç—å –∑ —ñ—Å–Ω—É—é—á–∏–º–∏)
const rpsGameArea = document.getElementById('rpsGameArea');
const proposeRpsGameBtn = document.getElementById('proposeRpsGameBtn');
const quitRpsGameBtn = document.getElementById('quitRpsGameBtn');
const rpsStatus = document.getElementById('rpsStatus');
const rpsScoreDisplay = document.getElementById('rpsScore'); // –£ HTML id="rpsScore"
const rpsChoices = document.getElementById('rpsChoices');
const rpsPlayerMoves = document.getElementById('rpsPlayerMoves'); // –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ö–æ–¥—ñ–≤
const rpsOpponentMove = document.getElementById('rpsOpponentMove'); // –ë–ª–æ–∫ –¥–ª—è —Ö–æ–¥—É —Å—É–ø–µ—Ä–Ω–∏–∫–∞
const opponentChoiceDisplay = document.getElementById('opponentChoiceDisplay'); // Span –¥–ª—è —Ö–æ–¥—É —Å—É–ø–µ—Ä–Ω–∏–∫–∞
const rpsYourMove = document.getElementById('rpsYourMove'); // –ë–ª–æ–∫ –¥–ª—è —Ç–≤–æ–≥–æ —Ö–æ–¥—É
const yourChoiceDisplay = document.getElementById('yourChoiceDisplay'); // Span –¥–ª—è —Ç–≤–æ–≥–æ —Ö–æ–¥—É

let currentGameId = null;
let rpsPlayerNicknames = []; // –ë—É–¥–µ–º–æ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –Ω—ñ–∫–∏ –≥—Ä–∞–≤—Ü—ñ–≤ ['Baby üòé', 'Pink Cloud ‚òÅÔ∏è']
let rpsLocalScores = { player1: 0, player2: 0 }; // –õ–æ–∫–∞–ª—å–Ω–∏–π —Ä–∞—Ö—É–Ω–æ–∫ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è, —ñ–º–µ–Ω–∞ –±—É–¥—É—Ç—å –∑ rpsPlayerNicknames

// –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó —Ö–æ–¥—É (–∫–∞–º—ñ–Ω—å, –Ω–æ–∂–∏—Ü—ñ, –ø–∞–ø—ñ—Ä)
function visualizeRpsMove(move) {
    if (move === 'rock') return '–ö–∞–º—ñ–Ω—å ‚úä';
    if (move === 'paper') return '–ü–∞–ø—ñ—Ä ‚úã';
    if (move === 'scissors') return '–ù–æ–∂–∏—Ü—ñ ‚úåÔ∏è';
    return '?'; // –Ø–∫—â–æ —Ö—ñ–¥ —â–µ –Ω–µ–≤—ñ–¥–æ–º–∏–π
}

// –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤–∏–¥–∏–º–æ—Å—Ç—ñ –∫–Ω–æ–ø–∫–∏ "–ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –≥—Ä—É"
function updateProposeRpsButtonVisibility(usersOnline) {
  // usersOnline - —Ü–µ –º–∞—Å–∏–≤ –Ω—ñ–∫–Ω–µ–π–º—ñ–≤ ['Baby üòé', 'Pink Cloud ‚òÅÔ∏è']
  if (usersOnline.length === 2 && !currentGameId) { // –ü–æ–∫–∞–∑—É—î–º–æ, —è–∫—â–æ –¥–≤–æ—î —ñ –Ω–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–æ—ó –≥—Ä–∏
    proposeRpsGameBtn.style.display = 'inline-block';
  } else {
    proposeRpsGameBtn.style.display = 'none';
  }
}

// –°–∫–∏–¥–∞–Ω–Ω—è UI –≥—Ä–∏ –¥–æ –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ —Å—Ç–∞–Ω—É
function resetRpsUI(isLeavingGame = false) {
    rpsGameArea.style.display = 'none';
    rpsChoices.style.display = 'none';
    rpsPlayerMoves.style.display = 'none'; // –•–æ–≤–∞—î–º–æ –±–ª–æ–∫ –∑ —Ö–æ–¥–∞–º–∏
    rpsStatus.textContent = '';
    rpsScoreDisplay.textContent = '–†–∞—Ö—É–Ω–æ–∫: –¢–∏ 0 - –°—É–ø–µ—Ä–Ω–∏–∫ 0';
    opponentChoiceDisplay.textContent = '';
    yourChoiceDisplay.textContent = '';
    quitRpsGameBtn.style.display = 'none';
    
    currentGameId = null;
    rpsPlayerNicknames = [];
    rpsLocalScores = { player1: 0, player2: 0 };

    // –û–Ω–æ–≤–ª—é—î–º–æ –≤–∏–¥–∏–º—ñ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ "–ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –≥—Ä—É"
    // –ü–æ—Ç—Ä—ñ–±–Ω–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∞–∫—Ç—É–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, —è–∫—â–æ –≤—ñ–Ω –¥–æ—Å—Ç—É–ø–Ω–∏–π –≥–ª–æ–±–∞–ª—å–Ω–æ,
    // –∞–±–æ –ø–µ—Ä–µ–¥–∞—Ç–∏ –π–æ–≥–æ —Å—é–¥–∏. –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç–∏, –ø—Ä–∏–ø—É—Å—Ç–∏–º–æ, —â–æ usersOnlineDiv –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è.
    const usersOnlineElements = usersOnlineDiv.querySelectorAll('.finger');
    if (usersOnlineElements.length === 2) {
        proposeRpsGameBtn.style.display = 'inline-block';
    } else {
        proposeRpsGameBtn.style.display = 'none';
    }
}

// –û–±—Ä–æ–±–Ω–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≥—Ä–∏
if (proposeRpsGameBtn) {
    proposeRpsGameBtn.addEventListener('click', () => {
        if (socket && socket.connected) {
            console.log("–ö–ª—ñ—î–Ω—Ç: –ü—Ä–æ–ø–æ–Ω—É—é –≥—Ä—É –ö–ù–ü");
            socket.emit('propose_rps_game');
            rpsStatus.textContent = '–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ...';
            proposeRpsGameBtn.style.display = 'none';
        }
    });
}

if (quitRpsGameBtn) {
    quitRpsGameBtn.addEventListener('click', () => {
        if (socket && socket.connected && currentGameId) {
            socket.emit('quit_rps_game', { game_id: currentGameId });
            rpsStatus.textContent = '–í–∏ –ø–æ–∫–∏–Ω—É–ª–∏ –≥—Ä—É.'; // –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–ª—è —Å–µ–±–µ
            resetRpsUI(); 
        }
    });
}

document.querySelectorAll('.rps-btn').forEach(button => {
    button.addEventListener('click', () => {
        if (socket && socket.connected && currentGameId) {
            const move = button.getAttribute('data-move');
            console.log(`–ö–ª—ñ—î–Ω—Ç: –†–æ–±–ª—é —Ö—ñ–¥ ${move} —É –≥—Ä—ñ ${currentGameId}`);
            socket.emit('rps_make_move', { game_id: currentGameId, move: move });
            
            rpsStatus.textContent = '–•—ñ–¥ –∑—Ä–æ–±–ª–µ–Ω–æ, –æ—á—ñ–∫—É—î–º–æ –Ω–∞ —Å—É–ø–µ—Ä–Ω–∏–∫–∞...';
            yourChoiceDisplay.textContent = visualizeRpsMove(move);
            rpsYourMove.style.display = 'block'; // –ü–æ–∫–∞–∑—É—î–º–æ —Å–≤—ñ–π —Ö—ñ–¥
            rpsPlayerMoves.style.display = 'flex'; // –ü–æ–∫–∞–∑—É—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ö–æ–¥—ñ–≤
            rpsChoices.style.display = 'none'; // –•–æ–≤–∞—î–º–æ –∫–Ω–æ–ø–∫–∏ –≤–∏–±–æ—Ä—É –ø—ñ—Å–ª—è —Ö–æ–¥—É
        }
    });
});

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ Socket.IO –¥–ª—è –≥—Ä–∏
function initializeRpsClientSocketHandlers() {
    if (!socket) {
        console.error("Socket –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –¥–ª—è –≥—Ä–∏ –ö–ù–ü!");
        return;
    }

    socket.on('rps_invitation', (data) => {
        // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ñ—Å–Ω—É—é—á–µ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
        customConfirmModalText.textContent = `${data.inviter_nickname} –ø—Ä–æ–ø–æ–Ω—É—î –∑—ñ–≥—Ä–∞—Ç–∏ –≤ –ö–∞–º—ñ–Ω—å-–ù–æ–∂–∏—Ü—ñ-–ü–∞–ø—ñ—Ä! –ü—Ä–∏–π–Ω—è—Ç–∏?`;
        customConfirmOkBtn.onclick = () => {
            socket.emit('rps_accept_invite', { game_id: data.game_id });
            hideCustomConfirm();
            // UI –≥—Ä–∏ –æ–Ω–æ–≤–∏—Ç—å—Å—è –ø—Ä–∏ –æ—Ç—Ä–∏–º–∞–Ω–Ω—ñ 'rps_game_started'
        };
        customConfirmCancelBtn.onclick = () => {
            socket.emit('rps_decline_invite', { game_id: data.game_id });
            hideCustomConfirm();
        };
        customConfirmModalCloseBtn.onclick = customConfirmCancelBtn.onclick;
        customConfirmModal.style.display = 'flex';
    });

    socket.on('rps_game_started', (data) => {
        hideCustomConfirm(); // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª–∫—É, —è–∫—â–æ –≤–æ–Ω–∞ –±—É–ª–∞ –≤—ñ–¥–∫—Ä–∏—Ç–∞
        currentGameId = data.game_id;
        rpsPlayerNicknames = data.players; // –ú–∞—Å–∏–≤ –∑ –¥–≤–æ—Ö –Ω—ñ–∫–Ω–µ–π–º—ñ–≤
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ —Ä–∞—Ö—É–Ω–æ–∫ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
        // –ü—Ä–∏–ø—É—Å–∫–∞—î–º–æ, —â–æ selectedNickname - —Ü–µ –Ω—ñ–∫ –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–ª—ñ—î–Ω—Ç–∞
        const myNick = selectedNickname;
        const opponentNick = rpsPlayerNicknames.find(nick => nick !== myNick);
        rpsLocalScores = { [myNick]: 0, [opponentNick]: 0 };

        rpsGameArea.style.display = 'block';
        rpsStatus.textContent = '–ì—Ä–∞ –ø–æ—á–∞–ª–∞—Å—è! –í–∞—à —Ö—ñ–¥.';
        rpsScoreDisplay.textContent = `–†–∞—Ö—É–Ω–æ–∫: ${myNick} ${rpsLocalScores[myNick]} - ${opponentNick} ${rpsLocalScores[opponentNick]}`;
        
        rpsChoices.style.display = 'flex'; // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫–∏ –≤–∏–±–æ—Ä—É
        rpsPlayerMoves.style.display = 'none'; // –•–æ–≤–∞—î–º–æ —Ö–æ–¥–∏ –Ω–∞ –ø–æ—á–∞—Ç–∫—É —Ä–∞—É–Ω–¥—É
        rpsYourMove.style.display = 'block'; // –ì–æ—Ç—É—î–º–æ –º—ñ—Å—Ü–µ –¥–ª—è —Å–≤–æ–≥–æ —Ö–æ–¥—É
        rpsOpponentMove.style.display = 'block'; // –ì–æ—Ç—É—î–º–æ –º—ñ—Å—Ü–µ –¥–ª—è —Ö–æ–¥—É —Å—É–ø–µ—Ä–Ω–∏–∫–∞
        yourChoiceDisplay.textContent = visualizeRpsMove(null); // –û—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ö—ñ–¥
        opponentChoiceDisplay.textContent = visualizeRpsMove(null); // –û—á–∏—â–∞—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ö—ñ–¥

        proposeRpsGameBtn.style.display = 'none';
        quitRpsGameBtn.style.display = 'inline-block';
    });

    socket.on('rps_invite_declined', (data) => {
        rpsStatus.textContent = `${data.decliner_nickname} –≤—ñ–¥—Ö–∏–ª–∏–≤(–ª–∞) –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è.`;
        // –û–Ω–æ–≤–ª—é—î–º–æ –≤–∏–¥–∏–º—ñ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ "–ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –≥—Ä—É"
        const usersOnlineElements = usersOnlineDiv.querySelectorAll('.finger');
        if (usersOnlineElements.length === 2) {
            proposeRpsGameBtn.style.display = 'inline-block';
        }
    });

    socket.on('rps_waiting_for_opponent', () => {
        rpsStatus.textContent = '–û—á—ñ–∫—É—î–º–æ –Ω–∞ —Ö—ñ–¥ —Å—É–ø–µ—Ä–Ω–∏–∫–∞...';
        rpsChoices.style.display = 'none'; // –•–æ–≤–∞—î–º–æ –∫–Ω–æ–ø–∫–∏, –±–æ —Ö—ñ–¥ –≤–∂–µ –∑—Ä–æ–±–ª–µ–Ω–æ
    });

    socket.on('rps_round_result', (data) => {
        rpsStatus.textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—É–Ω–¥—É: ${data.result_message}`;
        
        const myNick = selectedNickname;
        const opponentNick = rpsPlayerNicknames.find(nick => nick !== myNick);

        // –û–Ω–æ–≤–ª—é—î–º–æ –ª–æ–∫–∞–ª—å–Ω–∏–π —Ä–∞—Ö—É–Ω–æ–∫
        rpsLocalScores[myNick] = data.score[myNick];
        rpsLocalScores[opponentNick] = data.score[opponentNick];
        
        rpsScoreDisplay.textContent = `–†–∞—Ö—É–Ω–æ–∫: ${myNick} ${rpsLocalScores[myNick]} - ${opponentNick} ${rpsLocalScores[opponentNick]}`;

        // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ —Ö–æ–¥–∏
        yourChoiceDisplay.textContent = visualizeRpsMove(data.moves[myNick]);
        opponentChoiceDisplay.textContent = visualizeRpsMove(data.moves[opponentNick]);
        rpsPlayerMoves.style.display = 'flex'; // –ü–æ–∫–∞–∑—É—î–º–æ –±–ª–æ–∫ –∑ —Ö–æ–¥–∞–º–∏

        // –ì–æ—Ç—É—î–º–æ—Å—è –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ä–∞—É–Ω–¥—É
        setTimeout(() => {
            if (currentGameId) { // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≥—Ä–∞ —â–µ –∞–∫—Ç–∏–≤–Ω–∞
                rpsStatus.textContent = '–ù–∞—Å—Ç—É–ø–Ω–∏–π —Ä–∞—É–Ω–¥! –í–∞—à —Ö—ñ–¥.';
                rpsChoices.style.display = 'flex'; // –ü–æ–∫–∞–∑—É—î–º–æ –∫–Ω–æ–ø–∫–∏ –≤–∏–±–æ—Ä—É
                rpsPlayerMoves.style.display = 'none'; // –•–æ–≤–∞—î–º–æ —Ö–æ–¥–∏
                yourChoiceDisplay.textContent = visualizeRpsMove(null);
                opponentChoiceDisplay.textContent = visualizeRpsMove(null);
            }
        }, 3500); // –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–∏–º —Ä–∞—É–Ω–¥–æ–º
    });
    
    socket.on('rps_opponent_quit', (data) => {
        rpsStatus.textContent = `${data.quitter_nickname || '–°—É–ø–µ—Ä–Ω–∏–∫'} –ø–æ–∫–∏–Ω—É–≤ –≥—Ä—É.`;
        resetRpsUI();
    });

    socket.on('rps_game_terminated_by_server', (data) => {
        rpsStatus.textContent = data.message || '–ì—Ä–∞ –±—É–ª–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —Å–µ—Ä–≤–µ—Ä–æ–º (–º–æ–∂–ª–∏–≤–æ, —á–µ—Ä–µ–∑ –≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≥—Ä–∞–≤—Ü—è).';
        resetRpsUI();
    });

    // –û–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –∑–∞–≥–∞–ª—å–Ω–∏—Ö —Å—Ç–∞—Ç—É—Å–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞ (—è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ)
    socket.on('status_message', (data) => {
        // –ú–æ–∂–Ω–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—Ç–∏ —Ü—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ rpsStatus –∞–±–æ –≤ —ñ–Ω—à–æ–º—É –º—ñ—Å—Ü—ñ
        if (rpsGameArea.style.display === 'block' && rpsStatus.textContent.includes('–ó–∞–ø—Ä–æ—à–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ...')) {
             // –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É—î–º–æ, —è–∫—â–æ –≤–∂–µ —î —Å—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—è, –∞–±–æ –¥–æ–¥–∞—î–º–æ –¥–æ –Ω—å–æ–≥–æ
        } else if (rpsGameArea.style.display === 'block') {
            rpsStatus.textContent = data.message;
        }
        console.log("–°—Ç–∞—Ç—É—Å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞:", data.message);
    });
     socket.on('action_error', (data) => {
        // –ú–æ–∂–Ω–∞ –≤—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ –ø–æ–º–∏–ª–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤ rpsStatus
        if (rpsGameArea.style.display === 'block') { // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–º–∏–ª–∫—É, —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ —ñ–≥—Ä–æ–≤–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–∫—Ç–∏–≤–Ω–∏–π
            rpsStatus.textContent = `–ü–æ–º–∏–ª–∫–∞: ${data.message}`;
        }
        console.error("–ü–æ–º–∏–ª–∫–∞ –¥—ñ—ó –≤—ñ–¥ —Å–µ—Ä–≤–µ—Ä–∞:", data.message);
    });
}

// --- –ö—ñ–Ω–µ—Ü—å –∫–æ–¥—É –¥–ª—è –≥—Ä–∏ –ö–∞–º—ñ–Ω—å, –ù–æ–∂–∏—Ü—ñ, –ü–∞–ø—ñ—Ä ---


  </script>

</body>
</html>
