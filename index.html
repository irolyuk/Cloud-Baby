<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paradise</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.0/socket.io.js"></script>
</head>
<body>

  <!-- Ğ•ĞºÑ€Ğ°Ğ½ Ğ²Ñ…Ğ¾Ğ´Ñƒ -->
  <div class="login-screen" id="loginScreen">
    <h2>Ğ’Ñ…Ñ–Ğ´ Ñƒ Ğ¿Ğ°Ñ€Ğ°Ğ´Ğ°Ğ¹Ğ·</h2>
    <input type="password" id="passwordInput" placeholder="Ğ’Ğ²ĞµĞ´Ñ–Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ" />
    <div id="nicknameSelection" style="display: none;">
      <p>Ğ’Ğ¸Ğ±ĞµÑ€Ğ¸ ÑĞ²Ñ–Ğ¹ Ğ½Ñ–ĞºĞ½ĞµĞ¹Ğ¼ Ğ¼Ğ°Ğ½ÑĞ½Ñ Ğ¼Ğ¾Ñ:</p>
      <button onclick="chooseNickname('Baby ğŸ˜')">Baby ğŸ˜</button>
      <button onclick="chooseNickname('Pink Cloud â˜ï¸')">Pink Cloud â˜ï¸</button>
    </div>
    <button id="loginButton" onclick="checkPassword()">Ğ£Ğ²Ñ–Ğ¹Ñ‚Ğ¸</button>
    <p id="loginError" style="color:red;"></p>
  </div>

  <!-- Ğ§Ğ°Ñ‚ -->
  <div class="chat-container" id="chatContainer" style="display: none;">
    <h1>ğŸŒ¸ â¤ Rakhiv Paradise â¤ ğŸŒ¸</h1>
    <button id="openGalleryBtn" class="gallery-toggle-btn">ğŸ–¼ï¸</button>
    <div id="chat" class="chat-box"></div>
    <!-- ĞĞ¾Ğ²Ğ¸Ğ¹ ĞºĞ¾Ğ½Ñ‚ĞµĞ¹Ğ½ĞµÑ€ Ğ´Ğ»Ñ Ñ–Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ğ° Ğ½Ğ°Ğ±Ğ¾Ñ€Ñƒ Ñ‚ĞµĞºÑÑ‚Ñƒ Ğ²ÑĞµÑ€ĞµĞ´Ğ¸Ğ½Ñ– Ñ‡Ğ°Ñ‚Ñƒ -->
    <div id="chatTypingIndicator" class="typing-message-in-chat" style="visibility: hidden;"></div>
     <div class="media-controls-area">
      <!-- ... ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¼ÑƒĞ·Ğ¸ĞºĞ¸ Ñ‚Ğ° Ğ³ÑƒÑ‡Ğ½Ğ¾ÑÑ‚Ñ– ... -->
    </div>
    <!-- Ğ‘Ğ»Ğ¾Ğº Ğ´Ğ»Ñ Ğ²Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ¿Ğ¾Ğ¿ĞµÑ€ĞµĞ´Ğ½ÑŒĞ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ĞµĞ³Ğ»ÑĞ´Ñƒ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ñ– - ĞŸĞ•Ğ Ğ•ĞœĞ†Ğ©Ğ•ĞĞ Ğ¡Ğ®Ğ”Ğ˜ -->
    <div id="replyPreview" class="reply-preview" style="display: none;">
      <div class="reply-preview-content"><strong id="replyPreviewUser"></strong>: <span id="replyPreviewText"></span></div>
      <button id="cancelReplyBtn" class="cancel-reply-btn">&times;</button>
    </div>
    <div class="input-controls">
      <textarea class="chat-input" id="msgInput" placeholder="ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ..." rows="1"></textarea>
      <button id="emojiToggleBtn" class="emoji-toggle-btn">ğŸ˜Š</button>
      <input type="file" id="imageInput" accept="image/*" style="display: none;">
      <button id="attachImageBtn" class="attach-btn">ğŸ“</button>
      <button class="chat-button">ğŸ’¬</button>
      <div id="emojiPanel" class="emoji-panel" style="display: none;">
        <!-- Ğ•Ğ¼Ğ¾Ğ´Ğ·Ñ– Ğ±ÑƒĞ´ÑƒÑ‚ÑŒ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ñ– ÑÑĞ´Ğ¸ Ğ·Ğ° Ğ´Ğ¾Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ¾Ñ JavaScript -->
      </div>
    </div>
    <div class="status-messages-container">
      <div id="users-online" class="users-online"></div>      
      <div id="imageUploadIndicator" class="upload-indicator" style="display: none;">Ğ’Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ... ğŸ–¼ï¸</div>
    </div>
  </div>

  <!-- ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğµ Ğ²Ñ–ĞºĞ½Ğ¾ Ğ´Ğ»Ñ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½ÑŒ Ğ· Ñ‡Ğ°Ñ‚Ñƒ -->
  <div id="chatImageDisplayModal" class="gallery-modal" style="display: none;">
    <button id="closeChatImageDisplayModalBtn" class="gallery-close-btn">&times;</button>
    <div class="gallery-content">
      <img id="chatDisplayImage" src="" alt="Ğ—Ğ±Ñ–Ğ»ÑŒÑˆĞµĞ½Ğµ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ· Ñ‡Ğ°Ñ‚Ñƒ" style="max-width: 90vw; max-height: 90vh; object-fit: contain;" />
    </div>
  </div>

  <!-- ĞœĞ¾Ğ´Ğ°Ğ»ÑŒĞ½Ğµ Ğ²Ñ–ĞºĞ½Ğ¾ Ğ³Ğ°Ğ»ĞµÑ€ĞµÑ— -->
  <div id="imageGalleryModal" class="gallery-modal" style="display: none;">
    <button id="closeGalleryBtn" class="gallery-close-btn">&times;</button>
    <div class="gallery-content">
      <button id="prevImageBtn" class="gallery-nav-btn prev-btn" aria-label="Previous image">&lt;</button>
      <div class="gallery-images-container" id="galleryImagesContainer">
        <!-- Ğ—Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ±ÑƒĞ´ÑƒÑ‚ÑŒ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ñ– ÑÑĞ´Ğ¸ Ğ·Ğ° Ğ´Ğ¾Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ¾Ñ JavaScript -->
      </div>
      <button id="nextImageBtn" class="gallery-nav-btn next-btn" aria-label="Next image">&gt;</button>
    </div>
  </div>
  <script>
    let selectedNickname = null;
    let socket = null;
    // ĞĞ³Ğ¾Ğ»Ğ¾ÑˆÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ»ĞµÑ”Ñ€ Ñ‚Ğ° Ğ¿Ğ¾Ğ²'ÑĞ·Ğ°Ğ½Ñ– Ğ·Ğ¼Ñ–Ğ½Ğ½Ñ– Ñ‚ÑƒÑ‚, Ñ‰Ğ¾Ğ± Ğ²Ğ¾Ğ½Ğ¸ Ğ±ÑƒĞ»Ğ¸ Ğ³Ğ»Ğ¾Ğ±Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ– Ğ² Ğ¼ĞµĞ¶Ğ°Ñ… ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ğ°
    const musicPlayer = new Audio();
    let currentPlayingButton = null;
    let currentReplyInfo = null; // Ğ”Ğ»Ñ Ğ·Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ğ½Ğ½Ñ Ñ–Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ñ–Ñ— Ğ¿Ñ€Ğ¾ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ, Ğ½Ğ° ÑĞºĞµ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ñ”Ğ¼Ğ¾
    let currentSongSrc = null;

    const avatars = {
     "Baby ğŸ˜": "ğŸ˜",
     "Pink Cloud â˜ï¸": "â˜ï¸"
    };
    
    const userColors = {
     "Baby ğŸ˜": "message-baby",
     "Pink Cloud â˜ï¸": "message-cloud"
    };

    function checkPassword() {
      const password = document.getElementById('passwordInput').value;
      const loginButton = document.getElementById('loginButton');
      if (password === "26060512") {
        document.getElementById('nicknameSelection').style.display = "block";
  passwordInput.style.display = "none"; // ĞŸÑ€Ğ¸Ñ…Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ
  loginButton.style.display = "none";   // ĞŸÑ€Ğ¸Ñ…Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ "Ğ£Ğ²Ñ–Ğ¹Ñ‚Ğ¸"
  document.getElementById('loginError').textContent = "";
      } else {
        document.getElementById('loginError').textContent = "ĞĞµĞ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ¸Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ.";
      }
    }

    function chooseNickname(nick) {
      selectedNickname = nick;
      document.getElementById('loginScreen').style.display = "none";
      document.getElementById('chatContainer').style.display = "flex";
      startChat();
    }

    function startChat() {
      socket = io("https://cloud-baby.onrender.com", {
        transports: ["websocket"]
      });

      const chat = document.getElementById('chat'); // Explicitly define chat
      socket.emit("register", selectedNickname); // Ğ¿ĞµÑ€ĞµĞ´Ğ°Ñ”Ğ¼Ğ¾ Ğ½Ñ–Ğº


      socket.on("message", (data) => { // ĞĞ±Ñ€Ğ¾Ğ±Ğ½Ğ¸Ğº Ğ½Ğ¾Ğ²Ğ¸Ñ… Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½ÑŒ
        const messageElement = renderMessage(data); // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ renderMessage Ğ´Ğ»Ñ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°
        chat.appendChild(messageElement);
        scrollToBottom();
      });

      socket.on('message_edited', (data) => {
        const messageDiv = document.querySelector(`.message[data-message-id="${data.messageId}"]`);
        if (messageDiv) {
          const textContentElement = messageDiv.querySelector('.message-text-content');
          if (textContentElement) {
            textContentElement.textContent = data.newText; // ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ñ‚ĞµĞºÑÑ‚

            // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ°Ğ±Ğ¾ Ğ¾Ğ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ·Ğ½Ğ°Ñ‡ĞºÑƒ "(Ğ²Ñ–Ğ´Ñ€ĞµĞ´Ğ°Ğ³Ğ¾Ğ²Ğ°Ğ½Ğ¾)"
            let editedMark = messageDiv.querySelector('.edited-indicator');
            if (!editedMark) {
              editedMark = document.createElement('span');
              editedMark.classList.add('edited-indicator');
              editedMark.style.fontSize = '0.8em'; // Ğ¢Ñ€Ğ¾Ñ…Ğ¸ Ğ¼ĞµĞ½ÑˆĞ¸Ğ¹ ÑˆÑ€Ğ¸Ñ„Ñ‚ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ·Ğ½Ğ°Ñ‡ĞºĞ¸
              editedMark.style.marginLeft = '5px'; // ĞĞµĞ²ĞµĞ»Ğ¸ĞºĞ¸Ğ¹ Ğ²Ñ–Ğ´ÑÑ‚ÑƒĞ¿
              editedMark.textContent = '(Ğ²Ñ–Ğ´Ñ€ĞµĞ´Ğ°Ğ³Ğ¾Ğ²Ğ°Ğ½Ğ¾)';
              textContentElement.insertAdjacentElement('afterend', editedMark);
            }
          }
        }
      });

      socket.on('message_deleted', (data) => {
        const messageDiv = document.querySelector(`.message[data-message-id="${data.messageId}"]`);
        if (messageDiv) {
          messageDiv.remove();
        }
      });

      socket.on("chat_history", (messages) => { // ĞĞ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ¾Ğ±ĞºĞ¸ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½ÑŒ Ğ² Ñ–ÑÑ‚Ğ¾Ñ€Ñ–Ñ—
        messages.forEach(data => {
          const messageElement = renderMessage(data); // renderMessage Ñ‚ĞµĞ¿ĞµÑ€ Ğ¿Ğ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ” ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚
          chat.appendChild(messageElement);
        });
        scrollToBottom();
      });

      socket.on("users_online", (users) => {
        const usersOnlineDiv = document.getElementById('users-online');
        let displayString = "";

        const hasBaby = users.includes("Baby ğŸ˜");
        const hasCloud = users.includes("Pink Cloud â˜ï¸");

        if (hasBaby && hasCloud) {
          displayString = `
            <div class="finger-lightning-container">
              <div class="finger left">ğŸ‘‰</div>
              <div class="lightning"></div>
              <div class="finger right">ğŸ‘ˆ</div>
            </div>
          `;
        } else if (hasBaby) {
          displayString = `<div class="finger-lightning-container"><div>ğŸ‘‰</div></div>`;
        } else if (hasCloud) {
          displayString = `<div class="finger-lightning-container"><div>ğŸ‘ˆ</div></div>`;
        }
        
        usersOnlineDiv.innerHTML = displayString || "ĞÑ–ĞºĞ¾Ğ³Ğ¾ Ğ½ĞµĞ¼Ğ°Ñ” Ğ² Ğ¼ĞµÑ€ĞµĞ¶Ñ–";
      });

      socket.on("typing", (data) => {
        const chatTypingIndicator = document.getElementById("chatTypingIndicator"); // ĞĞ¾Ğ²Ğ¸Ğ¹ Ñ–Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€
        if (data.typing) {          
          const userAvatar = avatars[data.user] || "ğŸ‘¤"; // Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ userAvatar Ñ‚ÑƒÑ‚
          chatTypingIndicator.textContent = `${userAvatar} ${data.user} ÑˆĞ¾ÑÑŒ Ñ‚Ğ°Ğ¼ Ñ†Ñ–ĞºĞ°Ğ²ĞµĞ½ÑŒĞºĞµ Ğ¿Ğ¸ÑˆĞµ...Ğ»ÑĞ±Ğ»ÑÑ‡Ğ¸ Ñ‚ĞµĞ±Ğµ Ğ´ÑƒĞ¶Ğµ ÑĞ¸Ğ»ÑŒĞ½Ğ¾!`;
          chatTypingIndicator.style.visibility = 'visible';
          scrollToBottom(); // ĞŸÑ€Ğ¾ĞºÑ€ÑƒÑ‚Ğ¸Ñ‚Ğ¸ Ğ²Ğ½Ğ¸Ğ·, Ñ‰Ğ¾Ğ± Ğ±ÑƒĞ»Ğ¾ Ğ²Ğ¸Ğ´Ğ½Ğ¾ Ñ–Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€
        } else {
          chatTypingIndicator.style.visibility = 'hidden';
          // chatTypingIndicator.textContent = '\u00A0'; // ĞœĞ¾Ğ¶Ğ½Ğ° Ğ´Ğ¾Ğ´Ğ°Ñ‚Ğ¸ Ğ½ĞµÑ€Ğ¾Ğ·Ñ€Ğ¸Ğ²Ğ½Ğ¸Ğ¹ Ğ¿Ñ€Ğ¾Ğ±Ñ–Ğ», Ñ‰Ğ¾Ğ± Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚ÑƒĞ²Ğ°Ñ‚Ğ¸ Ğ²Ğ¸ÑĞ¾Ñ‚Ñƒ, ÑĞºÑ‰Ğ¾ min-height Ğ½Ğµ ÑĞ¿Ñ€Ğ°Ñ†ÑÑ”
        }
      });


      socket.emit("get_history");

      const msgInput = document.getElementById("msgInput");
      let typingTimeout;

      msgInput.addEventListener("input", () => {
        socket.emit("typing", true);
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.emit("typing", false);
        }, 2000);
      });

      msgInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });

      document.querySelector(".chat-button").addEventListener("click", () => sendMessage());
      
      const attachImageBtn = document.getElementById('attachImageBtn');
      const imageInput = document.getElementById('imageInput');

      attachImageBtn.addEventListener('click', () => {
        imageInput.click(); // Ğ’Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ¸ Ğ´Ñ–Ğ°Ğ»Ğ¾Ğ³ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñƒ Ñ„Ğ°Ğ¹Ğ»Ñƒ
      });

      imageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
          const uploadIndicator = document.getElementById('imageUploadIndicator');
          uploadIndicator.style.display = 'block'; // ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚Ğ¸ Ñ–Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€

          const reader = new FileReader();
          reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
              const canvas = document.createElement('canvas');
              const MAX_WIDTH = 800; // ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ° ÑˆĞ¸Ñ€Ğ¸Ğ½Ğ°
              const MAX_HEIGHT = 600; // ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ° Ğ²Ğ¸ÑĞ¾Ñ‚Ğ°
              let width = img.width;
              let height = img.height;

              if (width > height) {
                if (width > MAX_WIDTH) {
                  height *= MAX_WIDTH / width;
                  width = MAX_WIDTH;
                }
              } else {
                if (height > MAX_HEIGHT) {
                  width *= MAX_HEIGHT / height;
                  height = MAX_HEIGHT;
                }
              }
              canvas.width = width;
              canvas.height = height;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(img, 0, 0, width, height);

              // ĞÑ‚Ñ€Ğ¸Ğ¼ÑƒÑ”Ğ¼Ğ¾ ÑÑ‚Ğ¸ÑĞ½ĞµĞ½Ğµ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ ÑĞº JPEG Ğ· ÑĞºÑ–ÑÑ‚Ñ 0.9 (Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ·Ğ¼Ñ–Ğ½ÑĞ²Ğ°Ñ‚Ğ¸)
              const compressedImageDataUrl = canvas.toDataURL('image/jpeg', 0.9); 

              socket.emit("message", { type: 'image', image: compressedImageDataUrl }, () => {
                uploadIndicator.style.display = 'none';
              });
            }
            img.src = e.target.result; // Ğ—Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ÑƒÑ”Ğ¼Ğ¾ Ğ¾Ñ€Ğ¸Ğ³Ñ–Ğ½Ğ°Ğ»ÑŒĞ½Ğµ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ¾Ğ±ĞºĞ¸
          }
          reader.readAsDataURL(file);
          imageInput.value = ''; // Ğ¡ĞºĞ¸Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ½Ñ Ñ–Ğ½Ğ¿ÑƒÑ‚Ñƒ, Ñ‰Ğ¾Ğ± Ğ¼Ğ¾Ğ¶Ğ½Ğ° Ğ±ÑƒĞ»Ğ¾ Ğ²Ğ¸Ğ±Ñ€Ğ°Ñ‚Ğ¸ Ñ‚Ğ¾Ğ¹ ÑĞ°Ğ¼Ğ¸Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ğ·Ğ½Ğ¾Ğ²Ñƒ
        } else if (file) { // Ğ¯ĞºÑ‰Ğ¾ Ñ„Ğ°Ğ¹Ğ» Ğ²Ğ¸Ğ±Ñ€Ğ°Ğ½Ğ¾, Ğ°Ğ»Ğµ Ñ†Ğµ Ğ½Ğµ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ
            alert("Ğ‘ÑƒĞ´ÑŒ Ğ»Ğ°ÑĞºĞ°, Ğ²Ğ¸Ğ±ĞµÑ€Ñ–Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ» Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ (JPEG, PNG, GIF).");
            uploadIndicator.style.display = 'none'; // ĞŸÑ€Ğ¸Ñ…Ğ¾Ğ²Ğ°Ñ‚Ğ¸ Ñ–Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€, ÑĞºÑ‰Ğ¾ Ñ„Ğ°Ğ¹Ğ» Ğ½Ğµ Ğ¿Ñ–Ğ´Ñ…Ğ¾Ğ´Ğ¸Ñ‚ÑŒ
        }
      });
    }

    // Ğ¤ÑƒĞ½ĞºÑ†Ñ–Ñ Ğ´Ğ»Ñ Ñ€ĞµĞ½Ğ´ĞµÑ€Ğ¸Ğ½Ğ³Ñƒ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ (Ñ‚ĞµĞºÑÑ‚ Ğ°Ğ±Ğ¾ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ)
    function renderMessage(data) {
      const messageDiv = document.createElement("div");
      messageDiv.classList.add("message");
      messageDiv.dataset.messageId = data.messageId; // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ ID Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ
      const colorClass = userColors[data.user];
      if (colorClass) messageDiv.classList.add(colorClass);

      // Ğ’Ñ–Ğ´Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ñ†Ğ¸Ñ‚Ğ¾Ğ²Ğ°Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ, ÑĞºÑ‰Ğ¾ Ğ²Ğ¾Ğ½Ğ¾ Ñ”
      if (data.replyTo) {
        const replyQuoteDiv = document.createElement('div');
        replyQuoteDiv.classList.add('message-reply-quote');
        
        const originalSender = document.createElement('strong');
        originalSender.textContent = data.replyTo.user;
        
        const originalText = document.createElement('span');
        originalText.textContent = `: ${data.replyTo.text}`; // Ğ¢ĞµĞºÑÑ‚ Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ğ¸

        replyQuoteDiv.appendChild(originalSender);
        replyQuoteDiv.appendChild(originalText);
        
        // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ¼Ğ¾Ğ¶Ğ»Ğ¸Ğ²Ñ–ÑÑ‚ÑŒ ĞºĞ»Ñ–ĞºĞ½ÑƒÑ‚Ğ¸ Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´Ñƒ Ğ´Ğ¾ Ğ¾Ñ€Ğ¸Ğ³Ñ–Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ
        replyQuoteDiv.onclick = () => scrollToMessage(data.replyTo.messageId);
        messageDiv.appendChild(replyQuoteDiv); // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ Ğ±Ğ»Ğ¾Ğº Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ğ¸ ĞŸĞ•Ğ Ğ•Ğ” Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ğ¸Ğ¼ Ğ²Ğ¼Ñ–ÑÑ‚Ğ¾Ğ¼
      }

      if (data.type === 'image' && data.image) {
        const img = document.createElement('img');
        img.src = data.image;
        img.alt = "Ğ—Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ²Ñ–Ğ´ " + data.user;
        img.classList.add('chat-image-thumbnail');
        img.onclick = () => displayChatImageFull(data.image);
        const senderInfo = document.createElement('span');
        senderInfo.textContent = `${avatars[data.user] || "ğŸ‘¤"} ${data.user}: `;
        senderInfo.classList.add('message-sender', 'message-sender-image'); // Ğ”Ğ¾Ğ´Ğ°Ñ”Ğ¼Ğ¾ ĞĞ‘Ğ˜Ğ”Ğ’Ğ ĞºĞ»Ğ°ÑĞ¸
        messageDiv.appendChild(senderInfo);
        messageDiv.appendChild(img);
      } else {
        // Ğ¡Ñ‚Ğ²Ğ¾Ñ€ÑÑ”Ğ¼Ğ¾ Ğ¾ĞºÑ€ĞµĞ¼Ñ– ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ¸ Ğ´Ğ»Ñ Ğ²Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ½Ğ¸ĞºĞ° Ñ‚Ğ° Ñ‚ĞµĞºÑÑ‚Ñƒ
        const senderInfo = document.createElement('span');
        senderInfo.textContent = `${avatars[data.user] || "ğŸ‘¤"} ${data.user}: `;
        senderInfo.classList.add('message-sender');

        const textContent = document.createElement('span');
        textContent.classList.add('message-text-content'); // ĞšĞ»Ğ°Ñ Ğ´Ğ»Ñ Ğ»ĞµĞ³ĞºĞ¾Ğ³Ğ¾ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ñƒ
        textContent.textContent = data.text;

        messageDiv.appendChild(senderInfo);
        messageDiv.appendChild(textContent);
      }

      const actionsDiv = document.createElement("div");
      actionsDiv.classList.add("message-actions");

      // Ğ’Ğ¸Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ñ–Ñ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº (Ğ·Ğ»Ñ–Ğ²Ğ°/ÑĞ¿Ñ€Ğ°Ğ²Ğ°) Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ Ğ²Ñ–Ğ´ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ° Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ
      if (data.user === "Baby ğŸ˜") { // ĞŸĞ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ Baby ÑĞ¿Ñ€Ğ°Ğ²Ğ°, ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ·Ğ»Ñ–Ğ²Ğ° Ğ²Ñ–Ğ´ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ
        actionsDiv.classList.add("actions-left");
      } else if (data.user === "Pink Cloud â˜ï¸") { // ĞŸĞ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ Cloud Ğ·Ğ»Ñ–Ğ²Ğ°, ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ ÑĞ¿Ñ€Ğ°Ğ²Ğ° Ğ²Ñ–Ğ´ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ
        actionsDiv.classList.add("actions-right");
      }

      // ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ’Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–ÑÑ‚Ğ¸" Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ´Ğ»Ñ Ğ²ÑÑ–Ñ… Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½ÑŒ
      const replyButton = document.createElement("button");
      replyButton.classList.add("action-btn", "reply-btn", "tooltip");
      replyButton.innerHTML = "&#8617;"; // Ğ¡Ğ¸Ğ¼Ğ²Ğ¾Ğ» Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ñ–
      replyButton.title = "Ğ’Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–ÑÑ‚Ğ¸";
      replyButton.onclick = () => startReply(data.messageId, data.user, data.type === 'text' ? data.text : "Ğ—Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ");

      // ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ "Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸" Ñ‚Ğ° "Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸" Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ– Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ğ´Ğ»Ñ Ğ²Ğ»Ğ°ÑĞ½Ğ¸Ñ… Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½ÑŒ
      if (data.user === selectedNickname) {
        const editButton = document.createElement("button");
        editButton.classList.add("action-btn", "edit-btn", "tooltip");
        editButton.innerHTML = "&#9998;"; 
        editButton.title = "Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸";
        editButton.onclick = () => startEditMessage(data.messageId, messageDiv, data.type === 'text' ? data.text : null);
        if (data.type !== 'text') editButton.style.display = 'none'; 

        const deleteButton = document.createElement("button");
        deleteButton.classList.add("action-btn", "delete-btn", "tooltip");
        deleteButton.innerHTML = "&#128465;"; 
        deleteButton.title = "Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸";
        deleteButton.onclick = () => deleteMessage(data.messageId);

        actionsDiv.appendChild(deleteButton); // ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº: Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸, Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ñ‚Ğ¸, Ğ’Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–ÑÑ‚Ğ¸
        actionsDiv.appendChild(editButton);
      }
      actionsDiv.appendChild(replyButton); // ĞšĞ½Ğ¾Ğ¿ĞºĞ° "Ğ’Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–ÑÑ‚Ğ¸" Ğ´Ğ¾Ğ´Ğ°Ñ”Ñ‚ÑŒÑÑ Ğ·Ğ°Ğ²Ğ¶Ğ´Ğ¸ (Ğ¾ÑÑ‚Ğ°Ğ½Ğ½ÑŒĞ¾Ñ Ğ´Ğ»Ñ ÑĞ²Ğ¾Ñ—Ñ… Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½ÑŒ)
      messageDiv.appendChild(actionsDiv);

      return messageDiv; // ĞŸĞ¾Ğ²ĞµÑ€Ñ‚Ğ°Ñ”Ğ¼Ğ¾ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¸Ğ¹ ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ·Ğ°Ğ¼Ñ–ÑÑ‚ÑŒ Ğ´Ğ¾Ğ´Ğ°Ğ²Ğ°Ğ½Ğ½Ñ Ğ¹Ğ¾Ğ³Ğ¾ Ğ² Ñ‡Ğ°Ñ‚ Ñ‚ÑƒÑ‚
    }

    function scrollToMessage(messageId) {
      const messageElement = document.querySelector(`.message[data-message-id="${messageId}"]`);
      if (messageElement) {
        messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        messageElement.classList.add('highlight-message'); // Ğ¢Ğ¸Ğ¼Ñ‡Ğ°ÑĞ¾Ğ²Ğ¾ Ğ¿Ñ–Ğ´ÑĞ²Ñ–Ñ‚Ğ¸Ñ‚Ğ¸
        setTimeout(() => messageElement.classList.remove('highlight-message'), 1500);
      }
    }
    function sendMessage() {
      const msgInput = document.getElementById("msgInput");
      const msg = msgInput.value.trim();
      if (msg && socket) {
        const messagePayload = { type: 'text', text: msg };
        if (currentReplyInfo) {
          messagePayload.replyTo = currentReplyInfo;
        }
        socket.emit("message", messagePayload);
        // ĞÑ‡Ğ¸Ñ‰Ğ°Ñ”Ğ¼Ğ¾ Ñ–Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ñ–Ñ Ğ¿Ñ€Ğ¾ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´ÑŒ Ñ‚Ğ° Ñ…Ğ¾Ğ²Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ¿ĞµÑ€ĞµĞ´Ğ½Ñ–Ğ¹ Ğ¿ĞµÑ€ĞµĞ³Ğ»ÑĞ´
        cancelReply(); 
        msgInput.value = "";
      }
    }

    function scrollToBottom() {
      const chatBox = document.getElementById("chat");
      chatBox.scrollTop = chatBox.scrollHeight;
    }

        function playMusic(songSrc, buttonElement) {
      if (musicPlayer.src.includes(songSrc) && !musicPlayer.paused) {
        // Ğ¢Ğ° ÑĞ°Ğ¼Ğ° Ğ¿Ñ–ÑĞ½Ñ Ğ³Ñ€Ğ°Ñ”, ÑÑ‚Ğ°Ğ²Ğ¸Ğ¼Ğ¾ Ğ½Ğ° Ğ¿Ğ°ÑƒĞ·Ñƒ
        musicPlayer.pause();
        buttonElement.classList.remove('playing');
        currentPlayingButton = null;
      } else if (musicPlayer.src.includes(songSrc) && musicPlayer.paused) {
        // Ğ¢Ğ° ÑĞ°Ğ¼Ğ° Ğ¿Ñ–ÑĞ½Ñ Ğ½Ğ° Ğ¿Ğ°ÑƒĞ·Ñ–, Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ²Ğ¶ÑƒÑ”Ğ¼Ğ¾ Ğ²Ñ–Ğ´Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ
        musicPlayer.play()
          .then(() => {
            if (currentPlayingButton && currentPlayingButton !== buttonElement) {
              currentPlayingButton.classList.remove('playing');
            }
            buttonElement.classList.add('playing');
            currentPlayingButton = buttonElement;
          })
          .catch(error => console.error("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ²Ğ¶ĞµĞ½Ğ½Ñ Ğ°ÑƒĞ´Ñ–Ğ¾:", error));
      } else {
        // ĞĞ¾Ğ²Ğ° Ğ¿Ñ–ÑĞ½Ñ Ğ°Ğ±Ğ¾ Ñ–Ğ½ÑˆĞ° Ğ²Ğ¸Ğ±Ñ€Ğ°Ğ½Ğ°
        if (currentPlayingButton) {
          currentPlayingButton.classList.remove('playing');
        }
        
        musicPlayer.src = songSrc;
        currentSongSrc = songSrc;
        musicPlayer.play()
          .then(() => {
            buttonElement.classList.add('playing');
            currentPlayingButton = buttonElement;
          })
          .catch(error => {
            console.error("ĞŸĞ¾Ğ¼Ğ¸Ğ»ĞºĞ° Ğ²Ñ–Ğ´Ñ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ½Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ°ÑƒĞ´Ñ–Ğ¾:", error);
            currentSongSrc = null;
          });
      }
    }

    musicPlayer.onended = function() {
      if (currentPlayingButton) {
        currentPlayingButton.classList.remove('playing');
        currentPlayingButton = null;
      }
      currentSongSrc = null;
    };

    // --- ĞšĞµÑ€ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ³ÑƒÑ‡Ğ½Ñ–ÑÑ‚Ñ ---
    const volumeToggleButton = document.getElementById('volumeToggleButton');
    const volumeSlider = document.getElementById('volumeSlider');

    function updateVolumeIcon(volume) {
      if (volume === 0) {
        volumeToggleButton.textContent = 'ğŸ”‡';
      } else if (volume <= 0.33) {
        volumeToggleButton.textContent = 'ğŸ”ˆ';
      } else if (volume <= 0.66) {
        volumeToggleButton.textContent = 'ğŸ”‰';
      } else {
        volumeToggleButton.textContent = 'ğŸ”Š';
      }
    }

    // Ğ†Ğ½Ñ–Ñ†Ñ–Ğ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ Ğ³ÑƒÑ‡Ğ½Ğ¾ÑÑ‚Ñ–
    let initialVolume = parseFloat(localStorage.getItem('playerVolume'));
    if (isNaN(initialVolume) || initialVolume < 0 || initialVolume > 1) {
      initialVolume = 0.5; // Ğ“ÑƒÑ‡Ğ½Ñ–ÑÑ‚ÑŒ Ğ·Ğ° Ğ·Ğ°Ğ¼Ğ¾Ğ²Ñ‡ÑƒĞ²Ğ°Ğ½Ğ½ÑĞ¼
    }
    musicPlayer.volume = initialVolume;
    volumeSlider.value = initialVolume;
    updateVolumeIcon(initialVolume);

    volumeToggleButton.addEventListener('click', () => {
      if (volumeSlider.style.display === 'none') {
        volumeSlider.style.display = 'inline-block'; // ĞĞ±Ğ¾ 'block' Ñ‡Ğ¸ 'flex' Ğ·Ğ°Ğ»ĞµĞ¶Ğ½Ğ¾ Ğ²Ñ–Ğ´ Ğ±Ğ°Ğ¶Ğ°Ğ½Ğ¾Ğ³Ğ¾ Ğ²Ğ¸Ğ³Ğ»ÑĞ´Ñƒ
      } else {
        volumeSlider.style.display = 'none';
      }
    });

    volumeSlider.addEventListener('input', function() {
      musicPlayer.volume = this.value;
      updateVolumeIcon(parseFloat(this.value));
      localStorage.setItem('playerVolume', this.value);
    });

    // Ğ—Ğ°ĞºÑ€Ğ¸Ğ²Ğ°Ñ‚Ğ¸ ÑĞ»Ğ°Ğ¹Ğ´ĞµÑ€ Ğ³ÑƒÑ‡Ğ½Ğ¾ÑÑ‚Ñ–, ÑĞºÑ‰Ğ¾ ĞºĞ»Ñ–ĞºĞ½ÑƒÑ‚Ğ¸ Ğ´ĞµÑ–Ğ½Ğ´Ğµ (Ğ¾Ğ¿Ñ†Ñ–Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾)
    // document.addEventListener('click', function(event) {
    //   if (!volumeControl.contains(event.target) && volumeSlider.style.display !== 'none') {
    //     volumeSlider.style.display = 'none';
    //   }
    // });

    // --- Ğ“Ğ°Ğ»ĞµÑ€ĞµÑ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½ÑŒ ---
    const openGalleryBtn = document.getElementById('openGalleryBtn');
    const closeGalleryBtn = document.getElementById('closeGalleryBtn');
    const imageGalleryModal = document.getElementById('imageGalleryModal');
    const galleryImagesContainer = document.getElementById('galleryImagesContainer');
    const prevImageBtn = document.getElementById('prevImageBtn');
    const nextImageBtn = document.getElementById('nextImageBtn');
    const chatDisplayModal = document.getElementById('chatImageDisplayModal');
    const emojiToggleBtn = document.getElementById('emojiToggleBtn');
    const emojiPanel = document.getElementById('emojiPanel');
    const chatDisplayImg = document.getElementById('chatDisplayImage');
    const closeChatImageDisplayBtn = document.getElementById('closeChatImageDisplayModalBtn');

    function displayChatImageFull(imageSrc) {
      chatDisplayImg.src = imageSrc;
      chatDisplayModal.style.display = 'flex';
      chatDisplayModal.classList.remove('hide');
      chatDisplayModal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    if (closeChatImageDisplayBtn) {
      closeChatImageDisplayBtn.addEventListener('click', () => {
        chatDisplayModal.classList.remove('show');
        chatDisplayModal.classList.add('hide');
        setTimeout(() => {
          if (chatDisplayModal.classList.contains('hide')) {
            chatDisplayModal.style.display = 'none';
          }
          document.body.style.overflow = 'auto';
        }, 400); // Ğ§Ğ°Ñ Ğ¼Ğ°Ñ” Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ñ‚Ğ¸ Ñ‚Ñ€Ğ¸Ğ²Ğ°Ğ»Ğ¾ÑÑ‚Ñ– CSS Ğ°Ğ½Ñ–Ğ¼Ğ°Ñ†Ñ–Ñ—
      });
    }

    // Ğ—ĞĞœĞ†ĞĞ˜ Ğ¦Ğ† Ğ¨Ğ›Ğ¯Ğ¥Ğ˜ ĞĞ Ğ¡Ğ’ĞĞ‡ Ğ—ĞĞ‘Ğ ĞĞ–Ğ•ĞĞĞ¯ Ğ’ ĞŸĞĞŸĞ¦Ğ† 'img'
    const galleryImageSources = [
      'img/1.jpg',
      'img/2.jpg',
      'img/3.jpg',
      'img/4.jpg',
      'img/5.jpg',
      'img/6.jpg',
      'img/7.jpg',
      'img/8.jpg',
      'img/9.jpg',
      'img/10.jpg'
      // Ğ”Ğ¾Ğ´Ğ°Ğ¹ Ğ±Ñ–Ğ»ÑŒÑˆĞµ ÑˆĞ»ÑÑ…Ñ–Ğ² Ğ´Ğ¾ Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½ÑŒ Ñ‚ÑƒÑ‚
    ];
    let imagesInGalleryLoaded = false;

    function populateGallery() {
      if (imagesInGalleryLoaded) return;
      galleryImagesContainer.innerHTML = ''; // ĞÑ‡Ğ¸ÑÑ‚Ğ¸Ñ‚Ğ¸ Ğ¿Ğ¾Ğ¿ĞµÑ€ĞµĞ´Ğ½Ñ–, ÑĞºÑ‰Ğ¾ Ñ”
      galleryImageSources.forEach(src => {
        const img = document.createElement('img');
        img.src = src;
        img.alt = "Ğ—Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ½Ñ Ğ· Ğ³Ğ°Ğ»ĞµÑ€ĞµÑ—";
        galleryImagesContainer.appendChild(img);
      });
      imagesInGalleryLoaded = true;
    }

    openGalleryBtn.addEventListener('click', () => {
      populateGallery();
      imageGalleryModal.style.display = 'flex'; // Ğ¡Ğ¿Ğ¾Ñ‡Ğ°Ñ‚ĞºÑƒ Ñ€Ğ¾Ğ±Ğ¸Ğ¼Ğ¾ Ğ±Ğ»Ğ¾Ğº Ğ²Ğ¸Ğ´Ğ¸Ğ¼Ğ¸Ğ¼
      imageGalleryModal.classList.remove('hide'); // Ğ’Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ ĞºĞ»Ğ°Ñ hide, ÑĞºÑ‰Ğ¾ Ğ²Ñ–Ğ½ Ñ”
      imageGalleryModal.classList.add('show');
      document.body.style.overflow = 'hidden'; // Ğ—Ğ°Ğ¿Ğ¾Ğ±Ñ–Ğ³Ñ‚Ğ¸ Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚Ñ†Ñ– Ñ„Ğ¾Ğ½Ñƒ
    });

    closeGalleryBtn.addEventListener('click', () => {
      imageGalleryModal.classList.remove('show');
      imageGalleryModal.classList.add('hide');
      
      // Ğ—Ğ°Ñ‡ĞµĞºĞ°Ñ‚Ğ¸ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ½Ñ Ğ°Ğ½Ñ–Ğ¼Ğ°Ñ†Ñ–Ñ— Ğ¿ĞµÑ€ĞµĞ´ Ñ‚Ğ¸Ğ¼, ÑĞº Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ²Ğ°Ñ‚Ğ¸ ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚ Ñ– Ğ²Ñ–Ğ´Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚ĞºÑƒ
      setTimeout(() => {
        // Ğ¯ĞºÑ‰Ğ¾ Ğ³Ğ°Ğ»ĞµÑ€ĞµÑ Ğ²ÑĞµ Ñ‰Ğµ Ğ¼Ğ°Ñ” ĞºĞ»Ğ°Ñ 'hide' (Ñ‚Ğ¾Ğ±Ñ‚Ğ¾ Ğ½Ğµ Ğ±ÑƒĞ»Ğ° Ğ²Ñ–Ğ´ĞºÑ€Ğ¸Ñ‚Ğ° Ğ·Ğ½Ğ¾Ğ²Ñƒ Ğ¿Ñ–Ğ´ Ñ‡Ğ°Ñ Ğ°Ğ½Ñ–Ğ¼Ğ°Ñ†Ñ–Ñ—)
        if (imageGalleryModal.classList.contains('hide')) {
          imageGalleryModal.style.display = 'none'; // ĞÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚
        }
        document.body.style.overflow = 'auto'; // Ğ’Ñ–Ğ´Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğ¸ Ğ¿Ñ€Ğ¾ĞºÑ€ÑƒÑ‚ĞºÑƒ Ñ„Ğ¾Ğ½Ñƒ
      }, 400); // Ğ§Ğ°Ñ Ğ¼Ğ°Ñ” Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ñ‚Ğ¸ Ñ‚Ñ€Ğ¸Ğ²Ğ°Ğ»Ğ¾ÑÑ‚Ñ– Ğ°Ğ½Ñ–Ğ¼Ğ°Ñ†Ñ–Ñ— fadeOutModal

    });

    prevImageBtn.addEventListener('click', () => {
      galleryImagesContainer.scrollBy({ left: -galleryImagesContainer.clientWidth, behavior: 'smooth' });
    });

    nextImageBtn.addEventListener('click', () => {
      galleryImagesContainer.scrollBy({ left: galleryImagesContainer.clientWidth, behavior: 'smooth' });
    });

    // --- ĞŸĞ°Ğ½ĞµĞ»ÑŒ Ğ•Ğ¼Ğ¾Ğ´Ğ·Ñ– ---
    const emojis = ['ğŸ˜€', 'ğŸ˜‚', 'ğŸ˜Š', 'ğŸ˜', 'ğŸ¤”', 'ğŸ˜¢', 'ğŸ˜ ', 'ğŸ‘', 'ğŸ‘', 'â¤ï¸', 'ğŸ‰', 'âœ¨', 'ğŸŒ¸', 'â˜ï¸', 'ğŸ˜', 'ğŸ‚', 'ğŸ’–', 'ğŸŒ ', 'ğŸ¤—', 'ğŸŒŒ', 'ğŸ˜˜', 'ğŸ˜œ', 'ğŸ˜‡', 'ğŸ¥³', 'ğŸ˜­', 'ğŸ™', 'ğŸ‘€', 'ğŸ‘‹', 'ğŸ”¥', 'ğŸ’¯'];

    function populateEmojiPanel() {
      emojis.forEach(emoji => {
        const emojiSpan = document.createElement('span');
        emojiSpan.textContent = emoji;
        emojiSpan.setAttribute('role', 'button'); // Ğ”Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ñ–
        emojiSpan.setAttribute('tabindex', '0');  // Ğ”Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ñ–
        emojiSpan.addEventListener('click', () => insertEmoji(emoji));
        emojiSpan.addEventListener('keydown', (e) => { // Ğ”Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚Ñ– Ğ· ĞºĞ»Ğ°Ğ²Ñ–Ğ°Ñ‚ÑƒÑ€Ğ¸
          if (e.key === 'Enter' || e.key === ' ') {
            insertEmoji(emoji);
          }
        });
        emojiPanel.appendChild(emojiSpan);
      });
    }

    function insertEmoji(emoji) {
      const msgInput = document.getElementById('msgInput');
      const start = msgInput.selectionStart;
      const end = msgInput.selectionEnd;
      const text = msgInput.value;
      msgInput.value = text.substring(0, start) + emoji + text.substring(end);
      msgInput.focus();
      msgInput.selectionStart = msgInput.selectionEnd = start + emoji.length;
      // ĞœĞ¾Ğ¶Ğ½Ğ° Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡Ğ½Ğ¾ Ñ…Ğ¾Ğ²Ğ°Ñ‚Ğ¸ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ¿Ñ–ÑĞ»Ñ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñƒ:
      // emojiPanel.style.display = 'none';
    }

    emojiToggleBtn.addEventListener('click', (event) => {
      event.stopPropagation(); // Ğ—ÑƒĞ¿Ğ¸Ğ½ÑÑ”Ğ¼Ğ¾ ÑĞ¿Ğ»Ğ¸Ğ²Ğ°Ğ½Ğ½Ñ Ğ¿Ğ¾Ğ´Ñ–Ñ—, Ñ‰Ğ¾Ğ± Ğ½Ğµ Ğ·Ğ°ĞºÑ€Ğ¸Ñ‚Ğ¸ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ¾Ğ´Ñ€Ğ°Ğ·Ñƒ
      emojiPanel.style.display = emojiPanel.style.display === 'none' ? 'grid' : 'none';
    });

    document.addEventListener('click', (event) => {
      if (emojiPanel.style.display === 'grid' && !emojiPanel.contains(event.target) && event.target !== emojiToggleBtn) {
        emojiPanel.style.display = 'none';
      }
    });
    populateEmojiPanel(); // Ğ—Ğ°Ğ¿Ğ¾Ğ²Ğ½ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ ĞµĞ¼Ğ¾Ğ´Ğ·Ñ– Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ²Ğ°Ğ½Ñ‚Ğ°Ğ¶ĞµĞ½Ğ½Ñ–

    // --- Ğ ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñ‚Ğ° Ğ’Ğ¸Ğ´Ğ°Ğ»ĞµĞ½Ğ½Ñ ĞŸĞ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½ÑŒ ---

    function deleteMessage(messageId) {
      if (confirm("Ğ’Ğ¸ Ğ²Ğ¿ĞµĞ²Ğ½ĞµĞ½Ñ–, Ñ‰Ğ¾ Ñ…Ğ¾Ñ‡ĞµÑ‚Ğµ Ğ²Ğ¸Ğ´Ğ°Ğ»Ğ¸Ñ‚Ğ¸ Ñ†Ğµ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ?")) {
        if (socket) {
          socket.emit('delete_message', { messageId });
        }
      }
    }

    function startEditMessage(messageId, messageDiv, currentText) {
      if (!currentText) return; 

      // ĞŸĞµÑ€ĞµĞ²Ñ–Ñ€ÑÑ”Ğ¼Ğ¾, Ñ‡Ğ¸ Ğ²Ğ¶Ğµ Ğ½Ğµ Ğ¹Ğ´Ğµ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñ†ÑŒĞ¾Ğ³Ğ¾ Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ
      if (messageDiv.querySelector('.edit-message-input')) {
        return;
      }

      const textContentElement = messageDiv.querySelector('.message-text-content');
      if (!textContentElement) {
        console.error("ĞĞµ Ğ²Ğ´Ğ°Ğ»Ğ¾ÑÑ Ğ·Ğ½Ğ°Ğ¹Ñ‚Ğ¸ .message-text-content Ğ´Ğ»Ñ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ²:", messageDiv);
        return;
      }
      // ĞĞ½Ğ¾Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ currentText, Ñ‰Ğ¾Ğ± Ğ²Ñ–Ğ½ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ²Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ°Ğ² Ğ²Ğ¼Ñ–ÑÑ‚Ñƒ ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ°, ÑĞºĞ¸Ğ¹ Ñ€ĞµĞ´Ğ°Ğ³ÑƒÑ”Ğ¼Ğ¾
      currentText = textContentElement.textContent;

      // Ğ¥Ğ¾Ğ²Ğ°Ñ”Ğ¼Ğ¾ Ğ¾Ñ€Ğ¸Ğ³Ñ–Ğ½Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¸Ğ¹ ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚ Ñ‚Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´Ñ–Ğ¹
      textContentElement.style.display = 'none';
      const actionsDiv = messageDiv.querySelector('.message-actions');
      if (actionsDiv) {
        actionsDiv.style.display = 'none';
      }
      
      const input = document.createElement('textarea');
      input.classList.add('edit-message-input');
      input.value = currentText; // Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ğ¼Ğ¾ Ñ‚ĞµĞºÑÑ‚ Ğ±ĞµĞ· Ğ¿Ñ€ĞµÑ„Ñ–ĞºÑÑƒ
      input.rows = Math.max(1, Math.min(5, (currentText.match(/\n/g) || []).length + 1)); 
      input.onkeydown = (e) => { 
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          saveButton.click();
        } else if (e.key === 'Escape') {
          cancelButton.click();
        }
      };
      
      const saveButton = document.createElement('button');
      saveButton.textContent = 'Ğ—Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸';
      saveButton.classList.add('action-btn', 'save-edit-btn');
      saveButton.onclick = () => {
        const newText = input.value.trim();

        if (newText && newText !== currentText) {
          if (socket) {
            socket.emit('edit_message', { messageId, newText });
          }
        } // Ğ¯ĞºÑ‰Ğ¾ Ñ‚ĞµĞºÑÑ‚ Ğ½Ğµ Ğ·Ğ¼Ñ–Ğ½Ğ¸Ğ²ÑÑ, Ğ½Ñ–Ñ‡Ğ¾Ğ³Ğ¾ Ğ½Ğµ Ñ€Ğ¾Ğ±Ğ¸Ğ¼Ğ¾, Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ğ·Ğ°ĞºÑ€Ğ¸Ğ²Ğ°Ñ”Ğ¼Ğ¾ Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ

        // ĞŸÑ€Ğ¸Ğ±Ğ¸Ñ€Ğ°Ñ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ñƒ Ñ‚Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ·Ğ±ĞµÑ€ĞµĞ³Ñ‚Ğ¸/ÑĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸
        messageDiv.removeChild(saveButton);
        messageDiv.removeChild(cancelButton);
        messageDiv.removeChild(input);

        // ĞŸĞ¾ĞºĞ°Ğ·ÑƒÑ”Ğ¼Ğ¾ Ğ¾Ñ€Ğ¸Ğ³Ñ–Ğ½Ğ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ğ¸Ğ¹ ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚ (Ğ¹Ğ¾Ğ³Ğ¾ Ğ²Ğ¼Ñ–ÑÑ‚ Ğ¾Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒÑÑ Ñ‡ĞµÑ€ĞµĞ· 'message_edited' Ğ¿Ğ¾Ğ´Ñ–Ñ)
        textContentElement.style.display = '';
        if (actionsDiv) actionsDiv.style.display = 'flex'; // ĞŸĞ¾ĞºĞ°Ğ·ÑƒÑ”Ğ¼Ğ¾ ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ´Ñ–Ğ¹
      };

      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'Ğ¡ĞºĞ°ÑÑƒĞ²Ğ°Ñ‚Ğ¸';
      cancelButton.classList.add('action-btn', 'cancel-edit-btn');
      cancelButton.onclick = () => {
        messageDiv.removeChild(saveButton);
        messageDiv.removeChild(cancelButton);
        messageDiv.removeChild(input);
        
        textContentElement.style.display = '';
        if (actionsDiv) actionsDiv.style.display = 'flex';
      };

      // Ğ’ÑÑ‚Ğ°Ğ²Ğ»ÑÑ”Ğ¼Ğ¾ Ğ¿Ğ¾Ğ»Ğµ Ğ²Ğ²Ğ¾Ğ´Ñƒ Ñ‚Ğ° ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¿Ñ–ÑĞ»Ñ ĞµĞ»ĞµĞ¼ĞµĞ½Ñ‚Ğ° Ğ²Ñ–Ğ´Ğ¿Ñ€Ğ°Ğ²Ğ½Ğ¸ĞºĞ° (ÑĞºÑ‰Ğ¾ Ğ²Ñ–Ğ½ Ñ”) Ğ°Ğ±Ğ¾ Ğ½Ğ° Ğ¿Ğ¾Ñ‡Ğ°Ñ‚Ğ¾Ğº
      const senderElement = messageDiv.querySelector('.message-sender');
      (senderElement || messageDiv.firstChild).insertAdjacentElement('afterend', input);
      input.insertAdjacentElement('afterend', saveButton); // ĞšĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¹Ğ´ÑƒÑ‚ÑŒ Ğ¿Ñ–ÑĞ»Ñ Ğ¿Ğ¾Ğ»Ñ Ğ²Ğ²Ğ¾Ğ´Ñƒ
      saveButton.insertAdjacentElement('afterend', cancelButton);
      input.focus();
      input.select(); // Ğ’Ğ¸Ğ´Ñ–Ğ»ÑÑ”Ğ¼Ğ¾ Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ Ğ·Ñ€ÑƒÑ‡Ğ½Ğ¾ÑÑ‚Ñ– Ñ€ĞµĞ´Ğ°Ğ³ÑƒĞ²Ğ°Ğ½Ğ½Ñ
    }

    // --- Ğ’Ñ–Ğ´Ğ¿Ğ¾Ğ²Ñ–Ğ´Ñ– Ğ½Ğ° Ğ¿Ğ¾Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ½Ñ ---
    const replyPreviewDiv = document.getElementById('replyPreview');
    const replyPreviewUser = document.getElementById('replyPreviewUser');
    const replyPreviewText = document.getElementById('replyPreviewText');
    const cancelReplyBtn = document.getElementById('cancelReplyBtn');

    function startReply(messageId, user, text) {
      currentReplyInfo = {
        messageId: messageId,
        user: user,
        // ĞĞ±Ñ€Ñ–Ğ·Ğ°Ñ”Ğ¼Ğ¾ Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ¿ĞµÑ€ĞµĞ´Ğ½ÑŒĞ¾Ğ³Ğ¾ Ğ¿ĞµÑ€ĞµĞ³Ğ»ÑĞ´Ñƒ, ÑĞºÑ‰Ğ¾ Ğ²Ñ–Ğ½ Ğ·Ğ°Ğ´Ğ¾Ğ²Ğ³Ğ¸Ğ¹
        text: text.length > 50 ? text.substring(0, 47) + "..." : text
      };

      replyPreviewUser.textContent = user;
      replyPreviewText.textContent = currentReplyInfo.text;
      replyPreviewDiv.style.display = 'flex';
      
      const msgInput = document.getElementById('msgInput');
      msgInput.focus(); // Ğ¤Ğ¾ĞºÑƒÑ Ğ½Ğ° Ğ¿Ğ¾Ğ»Ñ– Ğ²Ğ²Ğ¾Ğ´Ñƒ
    }

    function cancelReply() {
      currentReplyInfo = null;
      replyPreviewDiv.style.display = 'none';
    }

    if (cancelReplyBtn) {
      cancelReplyBtn.addEventListener('click', cancelReply);
    }
  </script>

</body>
</html>
